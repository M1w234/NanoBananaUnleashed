<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nana Banana Pro Unleashed - Analyze, Edit & Generate</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçå</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .mode-tab {
            transition: all 0.3s ease;
        }
        
        .mode-tab:not(.active) {
            opacity: 0.6;
        }
        
        .mode-tab.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .mode-tab.active.analyze-tab {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // ========================================
        // INDEXEDDB SETUP (Replaces localStorage for images)
        // ========================================
        const DB_NAME = 'GeminiImageToolsDB';
        const DB_VERSION = 2;
        const HISTORY_STORE = 'history';
        const COLLECTION_STORE = 'collection';
        const ANALYSIS_STORE = 'analysis';

        // Initialize IndexedDB
        let db = null;
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('‚ùå IndexedDB failed to open:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('‚úÖ IndexedDB opened successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    console.log('üì¶ Creating IndexedDB stores...');
                    const db = event.target.result;
                    
                    // Create history store if it doesn't exist
                    if (!db.objectStoreNames.contains(HISTORY_STORE)) {
                        const historyStore = db.createObjectStore(HISTORY_STORE, { keyPath: 'id' });
                        historyStore.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('‚úÖ Created history store');
                    }
                    
                    // Create collection store if it doesn't exist
                    if (!db.objectStoreNames.contains(COLLECTION_STORE)) {
                        const collectionStore = db.createObjectStore(COLLECTION_STORE, { keyPath: 'id' });
                        collectionStore.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('‚úÖ Created collection store');
                    }
                    
                    // Create analysis store if it doesn't exist
                    if (!db.objectStoreNames.contains(ANALYSIS_STORE)) {
                        const analysisStore = db.createObjectStore(ANALYSIS_STORE, { keyPath: 'id' });
                        analysisStore.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('‚úÖ Created analysis store');
                    }
                };
            });
        };

        // IndexedDB Helper Functions
        const dbHelpers = {
            // Add or update item
            put: (storeName, item) => {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(item);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Get single item by ID
            get: (storeName, id) => {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Get all items from store
            getAll: (storeName) => {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        // Sort by timestamp descending (newest first)
                        const results = request.result.sort((a, b) => 
                            new Date(b.timestamp) - new Date(a.timestamp)
                        );
                        resolve(results);
                    };
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Delete item by ID
            delete: (storeName, id) => {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Clear entire store
            clear: (storeName) => {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };

        // Helper function to generate truly unique IDs
        let idCounter = 0;
        const generateUniqueId = () => {
            return `${Date.now()}-${idCounter++}-${Math.random().toString(36).substr(2, 9)}`;
        };

        // Lucide React icons as simple SVG components
        const Camera = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const Zap = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const ChevronDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const Sparkles = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg>
        );

        const Clock = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const Folder = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const Trash = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const Plus = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );
        
        const Volume2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M11 5L6 9H2v6h4l5 4V5z" />
            </svg>
        );
        
        const Volume1 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072M11 5L6 9H2v6h4l5 4V5z" />
            </svg>
        );
        
        const VolumeX = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
            </svg>
        );

        const Key = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
        );

        const Eye = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
        );

        const EyeOff = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
            </svg>
        );

        const AlertTriangle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );
        
        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );
        
        const ArrowRight = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
        );

        // ========================================
        // API KEY SETTINGS MODAL
        // ========================================
        function ApiKeySettings({ isOpen, onClose, apiKey, onSave, selectedModel, onModelChange, availableModels, openaiKey, onSaveOpenai, openaiModel, onOpenaiModelChange, openaiModels }) {
            const [inputKey, setInputKey] = useState(apiKey || '');
            const [inputOpenaiKey, setInputOpenaiKey] = useState(openaiKey || '');
            const [inputModel, setInputModel] = useState(selectedModel || 'gemini-2.0-flash-exp-image-generation');
            const [inputOpenaiModel, setInputOpenaiModel] = useState(openaiModel || 'gpt-5.2');
            const [showKey, setShowKey] = useState(false);
            const [showOpenaiKey, setShowOpenaiKey] = useState(false);
            const [saved, setSaved] = useState(false);

            useEffect(() => {
                setInputKey(apiKey || '');
                setInputOpenaiKey(openaiKey || '');
                setInputModel(selectedModel || 'gemini-2.0-flash-exp-image-generation');
                setInputOpenaiModel(openaiModel || 'gpt-5.2');
            }, [apiKey, openaiKey, selectedModel, openaiModel]);

            const handleSave = () => {
                onSave(inputKey);
                onModelChange(inputModel);
                if (onSaveOpenai) onSaveOpenai(inputOpenaiKey);
                if (onOpenaiModelChange) onOpenaiModelChange(inputOpenaiModel);
                setSaved(true);
                setTimeout(() => setSaved(false), 2000);
            };

            const handleClear = () => {
                setInputKey('');
                onSave('');
                setSaved(true);
                setTimeout(() => setSaved(false), 2000);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl border border-slate-700">
                        <div className="flex items-center justify-between p-5 border-b border-slate-700">
                            <div className="flex items-center gap-3">
                                <Settings className="w-6 h-6 text-amber-500" />
                                <h2 className="text-xl font-bold text-white">API Settings</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white">
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="p-5 space-y-5">
                            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 flex gap-3">
                                <AlertTriangle className="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" />
                                <div className="text-sm text-amber-200 space-y-1">
                                    <p className="font-semibold">‚ö†Ô∏è Security Notice</p>
                                    <p className="text-xs">Your API keys are stored locally in your browser. Only use this on trusted devices.</p>
                                </div>
                            </div>

                            {/* Gemini Section */}
                            <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                                <h3 className="text-amber-400 font-semibold mb-3 flex items-center gap-2">
                                    <Sparkles className="w-4 h-4" /> Google Gemini (Edit & Generate)
                                </h3>
                                <div className="space-y-3">
                                    <div className="relative">
                                        <input
                                            type={showKey ? "text" : "password"}
                                            value={inputKey}
                                            onChange={(e) => setInputKey(e.target.value)}
                                            placeholder="AIza..."
                                            className="w-full bg-slate-900 text-white rounded-lg p-3 pr-11 border border-slate-600 focus:border-amber-500 focus:outline-none font-mono text-sm"
                                        />
                                        <button
                                            onClick={() => setShowKey(!showKey)}
                                            className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white"
                                        >
                                            {showKey ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                                        </button>
                                    </div>
                                    <select
                                        value={inputModel}
                                        onChange={(e) => setInputModel(e.target.value)}
                                        className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer text-sm"
                                    >
                                        {availableModels.map(model => (
                                            <option key={model.id} value={model.id}>{model.name}</option>
                                        ))}
                                    </select>
                                    <p className="text-slate-400 text-xs">
                                        Get your key from{' '}
                                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-amber-500 hover:underline">
                                            Google AI Studio
                                        </a>
                                    </p>
                                </div>
                            </div>

                            {/* OpenAI Section */}
                            <div className="bg-slate-900/50 rounded-lg p-4 border border-purple-500/30">
                                <h3 className="text-purple-400 font-semibold mb-3 flex items-center gap-2">
                                    <Search className="w-4 h-4" /> OpenAI Vision (Analyze)
                                </h3>
                                <div className="space-y-3">
                                    <div className="relative">
                                        <input
                                            type={showOpenaiKey ? "text" : "password"}
                                            value={inputOpenaiKey}
                                            onChange={(e) => setInputOpenaiKey(e.target.value)}
                                            placeholder="sk-..."
                                            className="w-full bg-slate-900 text-white rounded-lg p-3 pr-11 border border-slate-600 focus:border-purple-500 focus:outline-none font-mono text-sm"
                                        />
                                        <button
                                            onClick={() => setShowOpenaiKey(!showOpenaiKey)}
                                            className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white"
                                        >
                                            {showOpenaiKey ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                                        </button>
                                    </div>
                                    {openaiModels && (
                                        <select
                                            value={inputOpenaiModel}
                                            onChange={(e) => setInputOpenaiModel(e.target.value)}
                                            className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-purple-500 focus:outline-none cursor-pointer text-sm"
                                        >
                                            {openaiModels.map(model => (
                                                <option key={model.id} value={model.id}>{model.name}</option>
                                            ))}
                                        </select>
                                    )}
                                    <p className="text-slate-400 text-xs">
                                        Get your key from{' '}
                                        <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-purple-400 hover:underline">
                                            OpenAI Platform
                                        </a>
                                    </p>
                                </div>
                            </div>

                            {saved && (
                                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-3 flex items-center gap-2">
                                    <CheckCircle className="w-4 h-4 text-green-500" />
                                    <span className="text-green-400 font-semibold text-sm">Saved successfully!</span>
                                </div>
                            )}

                            <div className="flex gap-3">
                                <button
                                    onClick={handleSave}
                                    className="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold py-2.5 px-4 rounded-lg transition-all shadow-lg text-sm"
                                >
                                    Save All Settings
                                </button>
                                {apiKey && (
                                    <button
                                        onClick={handleClear}
                                        className="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors text-sm"
                                    >
                                        Clear Gemini
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function GeminiImageTools() {
            // Available models for selection
            const availableModels = [
                { id: 'gemini-2.0-flash-exp-image-generation', name: 'Gemini 2.0 Flash Image Gen (Recommended)' },
                { id: 'gemini-3-pro-image', name: 'Gemini 3 Pro Image' },
                { id: 'gemini-3-pro-image-preview', name: 'Gemini 3 Pro Image Preview' },
                { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro (Text/Edit only)' },
                { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash (Text/Edit only)' },
            ];
            
            const openaiModels = [
                { id: 'gpt-5.2', name: 'GPT-5.2 (Latest)' },
                { id: 'gpt-5.1', name: 'GPT-5.1' },
                { id: 'gpt-5', name: 'GPT-5' },
                { id: 'gpt-4o', name: 'GPT-4o' },
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini (Fast)' },
                { id: 'gpt-4-turbo', name: 'GPT-4 Turbo' },
            ];

            // API Key state (loaded from localStorage)
            const [apiKey, setApiKey] = useState('');
            const [openaiKey, setOpenaiKey] = useState('');
            const [selectedModel, setSelectedModel] = useState('gemini-2.0-flash-exp-image-generation');
            const [openaiModel, setOpenaiModel] = useState('gpt-5.2');
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [soundVolume, setSoundVolume] = useState(() => {
                const saved = localStorage.getItem('sound_volume');
                return saved || 'normal'; // 'off', 'low', 'normal'
            });
            
            // Play a pleasant chime sound using Web Audio API
            const playChime = () => {
                if (soundVolume === 'off') return;
                
                const volumeLevel = soundVolume === 'low' ? 0.1 : 0.3;
                
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Create a pleasant two-tone chime
                    const playTone = (frequency, startTime, duration) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = frequency;
                        oscillator.type = 'sine';
                        
                        // Envelope for pleasant sound
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(volumeLevel, startTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                        
                        oscillator.start(startTime);
                        oscillator.stop(startTime + duration);
                    };
                    
                    const now = audioContext.currentTime;
                    playTone(880, now, 0.15);        // A5
                    playTone(1108.73, now + 0.1, 0.2); // C#6
                    playTone(1318.51, now + 0.2, 0.3); // E6
                    
                    // Clean up after sounds finish
                    setTimeout(() => audioContext.close(), 1000);
                } catch (e) {
                    console.log('Audio not supported:', e);
                }
            };
            
            const cycleVolume = () => {
                const levels = ['off', 'low', 'normal'];
                const currentIndex = levels.indexOf(soundVolume);
                const nextIndex = (currentIndex + 1) % levels.length;
                const newValue = levels[nextIndex];
                setSoundVolume(newValue);
                localStorage.setItem('sound_volume', newValue);
                if (newValue !== 'off') {
                    // Small delay to let state update, then play test chime
                    setTimeout(() => {
                        const volumeLevel = newValue === 'low' ? 0.1 : 0.3;
                        try {
                            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            const playTone = (frequency, startTime, duration) => {
                                const oscillator = audioContext.createOscillator();
                                const gainNode = audioContext.createGain();
                                oscillator.connect(gainNode);
                                gainNode.connect(audioContext.destination);
                                oscillator.frequency.value = frequency;
                                oscillator.type = 'sine';
                                gainNode.gain.setValueAtTime(0, startTime);
                                gainNode.gain.linearRampToValueAtTime(volumeLevel, startTime + 0.05);
                                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                                oscillator.start(startTime);
                                oscillator.stop(startTime + duration);
                            };
                            const now = audioContext.currentTime;
                            playTone(880, now, 0.15);
                            playTone(1108.73, now + 0.1, 0.2);
                            playTone(1318.51, now + 0.2, 0.3);
                            setTimeout(() => audioContext.close(), 1000);
                        } catch (e) {}
                    }, 50);
                }
            };

            // Load API keys and models from localStorage on mount
            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) setApiKey(savedKey);
                
                const savedOpenaiKey = localStorage.getItem('openai_api_key');
                if (savedOpenaiKey) setOpenaiKey(savedOpenaiKey);
                
                const savedModel = localStorage.getItem('gemini_model');
                if (savedModel && availableModels.find(m => m.id === savedModel)) {
                    setSelectedModel(savedModel);
                } else {
                    setSelectedModel('gemini-2.0-flash-exp-image-generation');
                    localStorage.setItem('gemini_model', 'gemini-2.0-flash-exp-image-generation');
                }
                
                const savedOpenaiModel = localStorage.getItem('openai_model');
                if (savedOpenaiModel) setOpenaiModel(savedOpenaiModel);
            }, []);

            const handleSaveApiKey = (key) => {
                if (key) {
                    localStorage.setItem('gemini_api_key', key);
                    setApiKey(key);
                } else {
                    localStorage.removeItem('gemini_api_key');
                    setApiKey('');
                }
            };
            
            const handleSaveOpenaiKey = (key) => {
                if (key) {
                    localStorage.setItem('openai_api_key', key);
                    setOpenaiKey(key);
                } else {
                    localStorage.removeItem('openai_api_key');
                    setOpenaiKey('');
                }
            };
            
            const handleSaveOpenaiModel = (model) => {
                localStorage.setItem('openai_model', model);
                setOpenaiModel(model);
            };

            const handleSaveModel = (model) => {
                localStorage.setItem('gemini_model', model);
                setSelectedModel(model);
            };

            // Mode state
            const [mode, setMode] = useState('edit'); // 'analyze', 'edit', 'generate', 'multi', or 'combine'
            
            // ANALYZE MODE state
            const [analyzeImages, setAnalyzeImages] = useState([]);
            const [analyzePrompt, setAnalyzePrompt] = useState('Describe this image in detail. What do you see? Include colors, objects, composition, mood, and any text visible.');
            const [analyzeLoading, setAnalyzeLoading] = useState(false);
            const [analyzeResults, setAnalyzeResults] = useState([]);
            const [analyzeError, setAnalyzeError] = useState(null);
            const [analyzeDragActive, setAnalyzeDragActive] = useState(false);
            const analyzeFileInputRef = useRef(null);
            const [analysisHistory, setAnalysisHistory] = useState([]);
            const [analysisHistoryOpen, setAnalysisHistoryOpen] = useState(false);

            // EDIT MODE: Initialize image slots
            const [images, setImages] = useState(Array(20).fill(null).map((_, idx) => ({
                id: idx,
                image: null,
                imagePreview: null,
                prompt: '',
                aspectRatio: 'auto',
                resolution: '4K',
                variations: 1, // Number of variations to generate for this slot
                loading: false,
                result: null,
                results: [], // Array to store multiple variation results
                error: null,
                fromAnalysis: false // Track if image came from analysis
            })));

            const [visibleSlots, setVisibleSlots] = useState(1); // How many slots to show
            
            // History and collection - will load from IndexedDB
            const [history, setHistory] = useState([]);
            const [historyOpen, setHistoryOpen] = useState(false);
            const [expandedHistoryIds, setExpandedHistoryIds] = useState(new Set());
            
            const [uploadedCollection, setUploadedCollection] = useState([]);
            const [collectionOpen, setCollectionOpen] = useState(false);
            
            // Track if IndexedDB is ready
            const [dbReady, setDbReady] = useState(false);
            const [dbError, setDbError] = useState(null);
            
            // Image preview modal state
            const [modalOpen, setModalOpen] = useState(false);
            const [modalImage, setModalImage] = useState(null);
            const [modalTitle, setModalTitle] = useState('');
            
            // Function to open image in modal
            const openImageModal = (imageSrc, title = 'Image Preview') => {
                setModalImage(imageSrc);
                setModalTitle(title);
                setModalOpen(true);
            };
            
            // Function to close modal
            const closeModal = () => {
                setModalOpen(false);
                setModalImage(null);
                setModalTitle('');
            };
            
            // Close modal on ESC key
            useEffect(() => {
                const handleEsc = (e) => {
                    if (e.key === 'Escape' && modalOpen) {
                        closeModal();
                    }
                };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [modalOpen]);
            
            // Initialize IndexedDB and load data on mount
            useEffect(() => {
                const initializeDatabase = async () => {
                    try {
                        console.log('üîÑ Initializing IndexedDB...');
                        await initDB();
                        setDbReady(true);
                        
                        // Load history from IndexedDB
                        const historyData = await dbHelpers.getAll(HISTORY_STORE);
                        console.log('‚úÖ Loaded history from IndexedDB:', historyData.length, 'entries');
                        setHistory(historyData.slice(0, 100)); // Keep max 100
                        
                        // Load collection from IndexedDB
                        const collectionData = await dbHelpers.getAll(COLLECTION_STORE);
                        console.log('‚úÖ Loaded collection from IndexedDB:', collectionData.length, 'images');
                        setUploadedCollection(collectionData);
                        
                        // Load analysis history from IndexedDB
                        const analysisData = await dbHelpers.getAll(ANALYSIS_STORE);
                        console.log('‚úÖ Loaded analysis history from IndexedDB:', analysisData.length, 'entries');
                        setAnalysisHistory(analysisData.slice(0, 50)); // Keep max 50
                        
                    } catch (error) {
                        console.error('‚ùå Failed to initialize IndexedDB:', error);
                        setDbError(error.message);
                        alert('Failed to initialize storage. The app may not save your work.');
                    }
                };
                
                initializeDatabase();
            }, []); // Run once on mount
            
            // Toggle history prompt expansion
            const toggleHistoryExpand = (id) => {
                setExpandedHistoryIds(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(id)) {
                        newSet.delete(id);
                    } else {
                        newSet.add(id);
                    }
                    return newSet;
                });
            };

            const [bulkDragActive, setBulkDragActive] = useState(false);
            const [bulkSectionOpen, setBulkSectionOpen] = useState(false);
            const [combineDragActive, setCombineDragActive] = useState(false);
            const [duplicateImage, setDuplicateImage] = useState(null);
            const [duplicatePreview, setDuplicatePreview] = useState(null);
            const [duplicateCount, setDuplicateCount] = useState(3);
            const [duplicateSectionOpen, setDuplicateSectionOpen] = useState(false);
            const fileInputRefs = useRef([]);
            const duplicateInputRef = useRef(null);

            // GENERATE MODE: Array of generation slots
            const [genSlotsArray, setGenSlotsArray] = useState([{
                id: 0,
                prompt: '',
                aspectRatio: 'auto',
                resolution: '4K',
                variations: 1,
                loading: false,
                results: [],
                error: null
            }]);
            const [visibleGenSlots, setVisibleGenSlots] = useState(1);
            
            // Legacy single state for backward compatibility
            const [genPrompt, setGenPrompt] = useState('');
            const [genAspectRatio, setGenAspectRatio] = useState('auto');
            const [genResolution, setGenResolution] = useState('4K');
            const [genLoading, setGenLoading] = useState(false);
            const [genResult, setGenResult] = useState(null);
            const [genError, setGenError] = useState(null);
            const [genSlots, setGenSlots] = useState(1); // Number of variations to generate
            const [genResults, setGenResults] = useState([]); // Array to store multiple results

            // MULTI-IMAGE EDIT MODE: Multiple images, single prompt - now array-based
            const [multiSlotsArray, setMultiSlotsArray] = useState([{
                id: generateUniqueId(),
                images: [],
                prompt: '',
                aspectRatio: 'auto',
                resolution: '4K',
                variations: 1,
                loading: false,
                results: [],
                error: null
            }]);
            const [visibleMultiSlots, setVisibleMultiSlots] = useState(1);
            const [multiTargetSection, setMultiTargetSection] = useState(0); // Which section to add collection images to
            const multiFileInputRefs = useRef({});
            
            // Legacy state kept for compatibility
            const [multiImageCount, setMultiImageCount] = useState(5);
            const [multiImages, setMultiImages] = useState([]);
            const [multiPrompt, setMultiPrompt] = useState('');
            const [multiAspectRatio, setMultiAspectRatio] = useState('auto');
            const [multiResolution, setMultiResolution] = useState('4K');
            const [multiLoading, setMultiLoading] = useState(false);
            const [multiResults, setMultiResults] = useState([]);
            const [multiError, setMultiError] = useState(null);
            const multiFileInputRef = useRef(null);
            const [multiSlots, setMultiSlots] = useState(1); // Number of output variations per image
            const [multiDragActive, setMultiDragActive] = useState(false);

            // MULTI-IMAGE GENERATOR MODE: Combine multiple images - now array-based
            const [combineSlotsArray, setCombineSlotsArray] = useState([{
                id: generateUniqueId(),
                images: [],
                prompt: '',
                aspectRatio: '16:9',
                resolution: '4K',
                variations: 1,
                loading: false,
                results: [],
                error: null
            }]);
            const [visibleCombineSlots, setVisibleCombineSlots] = useState(1);
            const [combineTargetSection, setCombineTargetSection] = useState(0); // Which section to add collection images to
            const combineFileInputRefs = useRef({});
            
            // Legacy state kept for compatibility
            const [combineImages, setCombineImages] = useState([]);
            const [combinePrompt, setCombinePrompt] = useState('');
            const [combineAspectRatio, setCombineAspectRatio] = useState('16:9');
            const [combineResolution, setCombineResolution] = useState('4K');
            const [combineLoading, setCombineLoading] = useState(false);
            const [combineResults, setCombineResults] = useState([]); // Changed to array for multiple results
            const [combineError, setCombineError] = useState(null);
            const combineFileInputRef = useRef(null);
            const [combineSlots, setCombineSlots] = useState(1); // Number of combined variations to generate

            // === EDIT MODE FUNCTIONS ===
            const handleDuplicateFile = (file) => {
                if (!file || !file.type.startsWith('image/')) {
                    alert('Please upload an image file');
                    return;
                }

                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result.split(',')[1];
                    setDuplicateImage(base64String);
                    setDuplicatePreview(reader.result);
                };
                reader.readAsDataURL(file);
            };

            const fillDuplicates = () => {
                if (!duplicateImage) {
                    alert('Please upload an image first');
                    return;
                }

                // Auto-expand visible slots if needed
                const currentAvailable = images
                    .slice(0, visibleSlots)
                    .filter(img => !img.image).length;
                
                if (currentAvailable < duplicateCount) {
                    // Calculate how many more slots we need
                    const slotsNeeded = duplicateCount - currentAvailable;
                    const newVisibleSlots = Math.min(20, visibleSlots + slotsNeeded);
                    setVisibleSlots(newVisibleSlots);
                    
                    // Use timeout to let state update, then fill
                    setTimeout(() => {
                        const availableSlots = images
                            .slice(0, newVisibleSlots)
                            .map((img, idx) => ({ ...img, index: idx }))
                            .filter(img => !img.image);
                        
                        const slotsToFill = Math.min(duplicateCount, availableSlots.length);
                        availableSlots.slice(0, slotsToFill).forEach((slot) => {
                            updateImage(slot.index, {
                                image: duplicateImage,
                                imagePreview: duplicatePreview,
                                error: null,
                                result: null,
                                results: []
                            });
                        });
                    }, 50);
                    return;
                }

                const availableSlots = images
                    .slice(0, visibleSlots)
                    .map((img, idx) => ({ ...img, index: idx }))
                    .filter(img => !img.image);

                const slotsToFill = Math.min(duplicateCount, availableSlots.length);

                availableSlots.slice(0, slotsToFill).forEach((slot) => {
                    updateImage(slot.index, {
                        image: duplicateImage,
                        imagePreview: duplicatePreview,
                        error: null,
                        result: null,
                        results: []
                    });
                });
                // Success - no alert needed
            };

            const clearDuplicate = () => {
                setDuplicateImage(null);
                setDuplicatePreview(null);
                if (duplicateInputRef.current) {
                    duplicateInputRef.current.value = '';
                }
            };

            const handleBulkDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setBulkDragActive(true);
                } else if (e.type === "dragleave") {
                    setBulkDragActive(false);
                }
            };

            const handleBulkDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setBulkDragActive(false);
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );

                if (files.length === 0) return;

                // Find available slots (no image uploaded yet) within visible range
                let availableSlots = images
                    .slice(0, visibleSlots)
                    .map((img, idx) => ({ ...img, index: idx }))
                    .filter(img => !img.image);

                // If more files than available slots, auto-expand visible slots
                if (files.length > availableSlots.length) {
                    const slotsNeeded = files.length - availableSlots.length;
                    const newVisibleSlots = Math.min(20, visibleSlots + slotsNeeded);
                    setVisibleSlots(newVisibleSlots);
                    
                    // Recalculate available slots with new visible count
                    availableSlots = images
                        .slice(0, newVisibleSlots)
                        .map((img, idx) => ({ ...img, index: idx }))
                        .filter(img => !img.image);
                }

                // Fill available slots with dropped images
                const filesToProcess = files.slice(0, availableSlots.length);
                filesToProcess.forEach((file, fileIdx) => {
                    if (availableSlots[fileIdx]) {
                        handleFileInput(availableSlots[fileIdx].index, file);
                    }
                });

                // Only show alert if we couldn't fit all images (hit slot limit)
                if (files.length > availableSlots.length) {
                    alert(`Uploaded ${availableSlots.length} images. ${files.length - availableSlots.length} images skipped (max slots).`);
                }
            };
            
            // Duplicate section drag handlers
            const [duplicateDragActive, setDuplicateDragActive] = useState(false);
            
            const handleDuplicateDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDuplicateDragActive(true);
                } else if (e.type === "dragleave") {
                    setDuplicateDragActive(false);
                }
            };
            
            const handleDuplicateDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDuplicateDragActive(false);
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleDuplicateFile(file);
                }
            };

            const handleFileInput = (index, file) => {
                if (!file || !file.type.startsWith('image/')) {
                    updateImage(index, { error: 'Please upload an image file' });
                    return;
                }

                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result.split(',')[1];
                    updateImage(index, {
                        image: base64String,
                        imagePreview: reader.result,
                        error: null,
                        result: null,
                        results: []
                    });
                    // Auto-add to collection
                    addToCollection(reader.result, file.name);
                };
                reader.readAsDataURL(file);
            };

            const updateImage = (index, updates) => {
                setImages(prev => prev.map((img, idx) => 
                    idx === index ? { ...img, ...updates } : img
                ));
            };

            const removeImage = (index) => {
                updateImage(index, {
                    image: null,
                    imagePreview: null,
                    prompt: '',
                    result: null,
                    results: [],
                    error: null,
                    variations: 1
                });
                if (fileInputRefs.current[index]) {
                    fileInputRefs.current[index].value = '';
                }
            };

            const processImage = async (index) => {
                const img = images[index];
                
                if (!apiKey) {
                    setSettingsOpen(true);
                    return;
                }
                
                if (!img.image || !img.prompt.trim()) {
                    updateImage(index, { error: 'Please provide both an image and a prompt' });
                    return;
                }

                updateImage(index, { loading: true, error: null, results: [] });

                try {
                    const imageConfig = { imageSize: img.resolution };
                    if (img.aspectRatio !== 'auto') {
                        imageConfig.aspectRatio = img.aspectRatio;
                    }

                    // Generate img.variations number of results
                    const promises = Array.from({ length: img.variations }).map(async () => {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            { text: img.prompt },
                                            { inline_data: { mime_type: 'image/jpeg', data: img.image } }
                                        ]
                                    }],
                                    generationConfig: {
                                        responseModalities: ['IMAGE'],
                                        imageConfig: imageConfig
                                    }
                                })
                            }
                        );

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Failed to generate image');
                        }

                        const data = await response.json();
                        
                        if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                            return `data:image/jpeg;base64,${data.candidates[0].content.parts[0].inlineData.data}`;
                        } else {
                            throw new Error('Invalid response format from API');
                        }
                    });

                    const results = await Promise.all(promises);
                    
                    // Save to history
                    const historyEntry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        mode: 'edit',
                        prompt: img.prompt,
                        sourceImage: img.imagePreview,
                        results: results,
                        aspectRatio: img.aspectRatio,
                        resolution: img.resolution
                    };
                    addToHistory(historyEntry);
                    
                    updateImage(index, { 
                        result: results[0], // Keep first result for backward compatibility
                        results: results,
                        loading: false
                    });
                } catch (err) {
                    updateImage(index, { 
                        error: err.message || 'Failed to edit image',
                        loading: false
                    });
                }
            };
            
            // History management functions - NOW USES INDEXEDDB
            const addToHistory = async (entry) => {
                try {
                    await dbHelpers.put(HISTORY_STORE, entry);
                    setHistory(prev => {
                        const newHistory = [entry, ...prev].slice(0, 100); // Keep max 100
                        return newHistory;
                    });
                    console.log('üíæ Saved history entry to IndexedDB');
                    playChime(); // Play completion sound
                } catch (error) {
                    console.error('‚ùå Failed to save history:', error);
                    // Still add to state even if DB save fails
                    setHistory(prev => [entry, ...prev].slice(0, 100));
                    playChime(); // Still play sound on completion
                }
            };
            
            const clearHistory = async () => {
                if (confirm('Are you sure you want to clear all history?')) {
                    try {
                        await dbHelpers.clear(HISTORY_STORE);
                        setHistory([]);
                        console.log('üóëÔ∏è Cleared all history from IndexedDB');
                    } catch (error) {
                        console.error('‚ùå Failed to clear history:', error);
                        alert('Failed to clear history from storage');
                    }
                }
            };
            
            const removeFromHistory = async (id) => {
                try {
                    await dbHelpers.delete(HISTORY_STORE, id);
                    setHistory(prev => prev.filter(entry => entry.id !== id));
                    console.log('üóëÔ∏è Removed history entry from IndexedDB');
                } catch (error) {
                    console.error('‚ùå Failed to remove history:', error);
                    // Still remove from state even if DB delete fails
                    setHistory(prev => prev.filter(entry => entry.id !== id));
                }
            };
            
            // === ANALYZE MODE FUNCTIONS ===
            const handleAnalyzeDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setAnalyzeDragActive(true);
                } else if (e.type === "dragleave") {
                    setAnalyzeDragActive(false);
                }
            };

            const handleAnalyzeDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setAnalyzeDragActive(false);
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );
                if (files.length === 0) return;

                const remainingSlots = 10 - analyzeImages.length;
                const filesToProcess = files.slice(0, remainingSlots);

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        addToCollection(reader.result, file.name);
                        setAnalyzeImages(prev => [...prev, {
                            id: generateUniqueId(),
                            base64: reader.result.split(',')[1],
                            preview: reader.result,
                            fileName: file.name
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleAnalyzeFileSelect = (e) => {
                const files = Array.from(e.target.files || []).filter(file => 
                    file.type.startsWith('image/')
                );
                if (files.length === 0) return;

                const remainingSlots = 10 - analyzeImages.length;
                const filesToProcess = files.slice(0, remainingSlots);

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        addToCollection(reader.result, file.name);
                        setAnalyzeImages(prev => [...prev, {
                            id: generateUniqueId(),
                            base64: reader.result.split(',')[1],
                            preview: reader.result,
                            fileName: file.name
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = '';
            };

            const removeAnalyzeImage = (id) => {
                setAnalyzeImages(prev => prev.filter(img => img.id !== id));
            };

            const clearAnalyzeImages = () => {
                setAnalyzeImages([]);
                setAnalyzeResults([]);
                setAnalyzeError(null);
            };

            const processAnalysis = async () => {
                if (!openaiKey) {
                    setSettingsOpen(true);
                    return;
                }
                
                if (analyzeImages.length === 0) {
                    setAnalyzeError('Please upload at least one image');
                    return;
                }

                if (!analyzePrompt.trim()) {
                    setAnalyzeError('Please enter a prompt');
                    return;
                }

                setAnalyzeLoading(true);
                setAnalyzeError(null);
                setAnalyzeResults([]);

                try {
                    const results = [];
                    
                    for (const img of analyzeImages) {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${openaiKey}`
                            },
                            body: JSON.stringify({
                                model: openaiModel,
                                messages: [{
                                    role: 'user',
                                    content: [
                                        { type: 'text', text: analyzePrompt },
                                        {
                                            type: 'image_url',
                                            image_url: {
                                                url: `data:image/jpeg;base64,${img.base64}`,
                                                detail: 'high'
                                            }
                                        }
                                    ]
                                }],
                                max_completion_tokens: 1000
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Failed to analyze image');
                        }

                        const data = await response.json();
                        const analysis = data.choices?.[0]?.message?.content || 'No analysis available';
                        
                        results.push({
                            id: img.id,
                            preview: img.preview,
                            fileName: img.fileName,
                            analysis
                        });
                    }

                    setAnalyzeResults(results);

                    // Save to analysis history
                    const entry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        prompt: analyzePrompt,
                        images: analyzeImages.map(img => ({ preview: img.preview, fileName: img.fileName })),
                        results
                    };
                    addToAnalysisHistory(entry);

                } catch (err) {
                    setAnalyzeError(err.message || 'Failed to analyze images');
                } finally {
                    setAnalyzeLoading(false);
                }
            };

            const addToAnalysisHistory = async (entry) => {
                try {
                    await dbHelpers.put(ANALYSIS_STORE, entry);
                    setAnalysisHistory(prev => [entry, ...prev].slice(0, 50));
                    console.log('üíæ Saved analysis to IndexedDB');
                    playChime(); // Play completion sound
                } catch (error) {
                    console.error('‚ùå Failed to save analysis:', error);
                    setAnalysisHistory(prev => [entry, ...prev].slice(0, 50));
                    playChime(); // Still play sound on completion
                }
            };

            const removeFromAnalysisHistory = async (id) => {
                try {
                    await dbHelpers.delete(ANALYSIS_STORE, id);
                    setAnalysisHistory(prev => prev.filter(entry => entry.id !== id));
                } catch (error) {
                    console.error('‚ùå Failed to remove analysis:', error);
                    setAnalysisHistory(prev => prev.filter(entry => entry.id !== id));
                }
            };

            const clearAnalysisHistory = async () => {
                if (confirm('Are you sure you want to clear all analysis history?')) {
                    try {
                        await dbHelpers.clear(ANALYSIS_STORE);
                        setAnalysisHistory([]);
                    } catch (error) {
                        console.error('‚ùå Failed to clear analysis history:', error);
                    }
                }
            };

            const transferToEditor = (result) => {
                // Find empty slot or expand
                let targetIndex = images.slice(0, visibleSlots).findIndex(img => !img.image);
                
                if (targetIndex === -1) {
                    if (visibleSlots < 20) {
                        targetIndex = visibleSlots;
                        setVisibleSlots(prev => prev + 1);
                    } else {
                        return;
                    }
                }

                setTimeout(() => {
                    updateImage(targetIndex, {
                        image: result.preview.split(',')[1],
                        imagePreview: result.preview,
                        prompt: result.analysis.substring(0, 500),
                        error: null,
                        results: [],
                        fromAnalysis: true
                    });
                    setMode('edit');
                }, 50);
            };

            const transferAllToEditor = () => {
                analyzeResults.forEach((result, idx) => {
                    setTimeout(() => transferToEditor(result), idx * 100);
                });
            };
            
            const useFromCollectionForAnalyze = (img) => {
                if (analyzeImages.length < 10) {
                    setAnalyzeImages(prev => [...prev, {
                        id: generateUniqueId(),
                        base64: img.preview.split(',')[1],
                        preview: img.preview,
                        fileName: img.fileName
                    }]);
                }
            };
            
            // Uploaded collection management - NOW USES INDEXEDDB
            const addToCollection = async (imagePreview, fileName) => {
                const exists = uploadedCollection.some(img => img.preview === imagePreview);
                if (!exists) {
                    const newItem = {
                        id: generateUniqueId(),
                        preview: imagePreview,
                        fileName: fileName || `image-${Date.now()}.jpg`,
                        timestamp: new Date().toISOString()
                    };
                    
                    try {
                        await dbHelpers.put(COLLECTION_STORE, newItem);
                        setUploadedCollection(prev => [...prev, newItem]);
                        console.log('üíæ Saved image to collection in IndexedDB');
                    } catch (error) {
                        console.error('‚ùå Failed to save to collection:', error);
                        alert('Failed to save image to collection. Storage may be full.');
                    }
                }
            };
            
            const removeFromCollection = async (id) => {
                try {
                    await dbHelpers.delete(COLLECTION_STORE, id);
                    setUploadedCollection(prev => prev.filter(img => img.id !== id));
                    console.log('üóëÔ∏è Removed image from collection');
                } catch (error) {
                    console.error('‚ùå Failed to remove from collection:', error);
                    // Still remove from state
                    setUploadedCollection(prev => prev.filter(img => img.id !== id));
                }
            };
            
            const downloadFromCollection = (img) => {
                const link = document.createElement('a');
                link.href = img.preview;
                link.download = img.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const downloadAllFromCollection = () => {
                uploadedCollection.forEach((img, idx) => {
                    setTimeout(() => downloadFromCollection(img), idx * 200);
                });
            };
            
            const clearCollection = async () => {
                if (confirm('Are you sure you want to clear the collection?')) {
                    try {
                        await dbHelpers.clear(COLLECTION_STORE);
                        setUploadedCollection([]);
                        console.log('üóëÔ∏è Cleared entire collection from IndexedDB');
                    } catch (error) {
                        console.error('‚ùå Failed to clear collection:', error);
                        alert('Failed to clear collection from storage');
                    }
                }
            };
            
            // Use image from collection in different modes
            const useFromCollectionForBatch = (img) => {
                // Find first available slot in batch editor
                const availableSlotIndex = images.slice(0, visibleSlots).findIndex(slot => !slot.image);
                if (availableSlotIndex === -1) {
                    // No available slots, try to expand
                    if (visibleSlots < 20) {
                        setVisibleSlots(prev => {
                            const newSlots = Math.min(20, prev + 1);
                            // Use the new slot
                            setTimeout(() => {
                                updateImage(prev, {
                                    image: img.preview.split(',')[1],
                                    imagePreview: img.preview,
                                    error: null,
                                    result: null,
                                    results: []
                                });
                            }, 50);
                            return newSlots;
                        });
                    } else {
                        alert('All slots are in use. Remove an image first.');
                    }
                    return;
                }
                updateImage(availableSlotIndex, {
                    image: img.preview.split(',')[1],
                    imagePreview: img.preview,
                    error: null,
                    result: null,
                    results: []
                });
            };
            
            const useFromCollectionForMulti = (img) => {
                if (multiImages.length >= 20) {
                    alert('Maximum images reached. Remove some first.');
                    return;
                }
                setMultiImages(prev => [...prev, {
                    base64: img.preview.split(',')[1],
                    preview: img.preview,
                    file: { name: img.fileName }
                }]);
            };
            
            const useFromCollectionForCombine = (img) => {
                if (combineImages.length >= 20) {
                    alert('Maximum images reached. Remove some first.');
                    return;
                }
                setCombineImages(prev => [...prev, {
                    base64: img.preview.split(',')[1],
                    preview: img.preview,
                    file: { name: img.fileName }
                }]);
            };

            const processAll = async () => {
                const imagesToProcess = images
                    .slice(0, visibleSlots)
                    .map((img, idx) => ({ ...img, index: idx }))
                    .filter(img => img.image && img.prompt.trim());

                if (imagesToProcess.length === 0) {
                    alert('Please add at least one image with a prompt');
                    return;
                }

                await Promise.all(imagesToProcess.map(img => processImage(img.index)));
            };

            const downloadImage = (index, variationIdx = 0) => {
                const img = images[index];
                const result = img.results?.[variationIdx] || img.result;
                if (!result) return;
                
                const link = document.createElement('a');
                link.href = result;
                link.download = `edited-image-${index + 1}${img.results?.length > 1 ? `-v${variationIdx + 1}` : ''}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const downloadAllVariations = (index) => {
                const img = images[index];
                if (!img.results || img.results.length === 0) return;
                
                img.results.forEach((result, varIdx) => {
                    setTimeout(() => downloadImage(index, varIdx), varIdx * 200);
                });
            };

            const downloadAll = () => {
                images.slice(0, visibleSlots).forEach((img, idx) => {
                    if (img.results && img.results.length > 0) {
                        img.results.forEach((result, varIdx) => {
                            setTimeout(() => downloadImage(idx, varIdx), (idx * 10 + varIdx) * 200);
                        });
                    }
                });
            };

            const getActiveCount = () => images.slice(0, visibleSlots).filter(img => img.image && img.prompt.trim()).length;
            const getCompletedCount = () => images.slice(0, visibleSlots).filter(img => img.results && img.results.length > 0).length;
            const getAvailableSlots = () => images.slice(0, visibleSlots).filter(img => !img.image).length;

            // Helper function to add a result image to the collection
            const addResultToCollection = (imageDataUrl, fileName) => {
                addToCollection(imageDataUrl, fileName || `result-${Date.now()}.jpg`);
            };

            // Helper function to iterate on a result - creates new slot with result as input
            const iterateInEditMode = (imageDataUrl) => {
                // Also add to collection for safekeeping
                addToCollection(imageDataUrl, `iterate-${Date.now()}.jpg`);
                
                // Find first empty slot or add new one
                const emptySlotIndex = images.slice(0, visibleSlots).findIndex(img => !img.image);
                const base64 = imageDataUrl.split(',')[1];
                
                if (emptySlotIndex >= 0) {
                    // Use existing empty slot
                    setImages(prev => prev.map((img, i) => 
                        i === emptySlotIndex ? { ...img, image: base64, imagePreview: imageDataUrl, loading: false, results: [], error: null } : img
                    ));
                } else if (visibleSlots < 20) {
                    // Add new slot and populate it
                    const newSlotIndex = visibleSlots;
                    setVisibleSlots(prev => prev + 1);
                    setTimeout(() => {
                        setImages(prev => prev.map((img, i) => 
                            i === newSlotIndex ? { ...img, image: base64, imagePreview: imageDataUrl, loading: false, results: [], error: null } : img
                        ));
                    }, 50);
                } else {
                    alert('All slots are in use. Clear a slot first.');
                }
            };

            // Helper to iterate in Multi-Edit mode
            const iterateInMultiMode = (imageDataUrl) => {
                // Also add to collection for safekeeping
                addToCollection(imageDataUrl, `iterate-${Date.now()}.jpg`);
                
                const newSlot = {
                    id: generateUniqueId(),
                    images: [{
                        id: generateUniqueId(),
                        base64: imageDataUrl.split(',')[1],
                        preview: imageDataUrl,
                        fileName: `iterate-${Date.now()}.jpg`
                    }],
                    prompt: '',
                    aspectRatio: 'auto',
                    resolution: '4K',
                    variations: 1,
                    loading: false,
                    results: [],
                    error: null
                };
                setMultiSlotsArray(prev => [...prev, newSlot]);
                setVisibleMultiSlots(prev => prev + 1);
            };

            // Helper to iterate in Combine mode
            const iterateInCombineMode = (imageDataUrl) => {
                // Also add to collection for safekeeping
                addToCollection(imageDataUrl, `iterate-${Date.now()}.jpg`);
                
                const newSlot = {
                    id: generateUniqueId(),
                    images: [{
                        id: generateUniqueId(),
                        base64: imageDataUrl.split(',')[1],
                        preview: imageDataUrl,
                        fileName: `iterate-${Date.now()}.jpg`
                    }],
                    prompt: '',
                    aspectRatio: '16:9',
                    resolution: '4K',
                    variations: 1,
                    loading: false,
                    results: [],
                    error: null
                };
                setCombineSlotsArray(prev => [...prev, newSlot]);
                setVisibleCombineSlots(prev => prev + 1);
            };

            // === GENERATE MODE FUNCTIONS ===
            const handleGenerate = async () => {
                if (!genPrompt.trim()) {
                    setGenError('Please enter a prompt');
                    return;
                }

                setGenLoading(true);
                setGenError(null);
                setGenResults([]);

                try {
                    const imageConfig = { imageSize: genResolution };
                    if (genAspectRatio !== 'auto') {
                        imageConfig.aspectRatio = genAspectRatio;
                    }

                    // Generate genSlots number of images
                    const promises = Array.from({ length: genSlots }).map(async () => {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{ text: genPrompt }]
                                    }],
                                    generationConfig: {
                                        responseModalities: ['IMAGE'],
                                        imageConfig: imageConfig
                                    }
                                })
                            }
                        );

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Failed to generate image');
                        }

                        const data = await response.json();
                        
                        if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                            return `data:image/jpeg;base64,${data.candidates[0].content.parts[0].inlineData.data}`;
                        } else {
                            throw new Error('Invalid response format from API');
                        }
                    });

                    const results = await Promise.all(promises);
                    setGenResults(results);
                    
                    // Save to history
                    const historyEntry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        mode: 'generate',
                        prompt: genPrompt,
                        sourceImage: null,
                        results: results,
                        aspectRatio: genAspectRatio,
                        resolution: genResolution
                    };
                    addToHistory(historyEntry);
                } catch (err) {
                    setGenError(err.message || 'Failed to generate image');
                } finally {
                    setGenLoading(false);
                }
            };

            const downloadGenerated = (index) => {
                if (!genResults[index]) return;
                const link = document.createElement('a');
                link.href = genResults[index];
                link.download = `generated-image-${index + 1}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const downloadAllGenerated = () => {
                genResults.forEach((result, idx) => {
                    setTimeout(() => downloadGenerated(idx), idx * 200);
                });
            };
            
            // === GENERATE MODE SLOT FUNCTIONS ===
            const updateGenSlot = (index, updates) => {
                setGenSlotsArray(prev => prev.map((slot, idx) => 
                    idx === index ? { ...slot, ...updates } : slot
                ));
            };
            
            const addGenSlot = () => {
                if (genSlotsArray.length >= 20) return;
                setGenSlotsArray(prev => [...prev, {
                    id: generateUniqueId(),
                    prompt: '',
                    aspectRatio: 'auto',
                    resolution: '4K',
                    variations: 1,
                    loading: false,
                    results: [],
                    error: null
                }]);
                setVisibleGenSlots(prev => Math.min(20, prev + 1));
            };
            
            const removeGenSlot = (index) => {
                if (genSlotsArray.length <= 1) return;
                setGenSlotsArray(prev => prev.filter((_, idx) => idx !== index));
                setVisibleGenSlots(prev => Math.max(1, prev - 1));
            };
            
            const processGenSlot = async (index) => {
                const slot = genSlotsArray[index];
                
                if (!apiKey) {
                    setSettingsOpen(true);
                    return;
                }
                
                if (!slot.prompt.trim()) {
                    updateGenSlot(index, { error: 'Please enter a prompt' });
                    return;
                }

                updateGenSlot(index, { loading: true, error: null, results: [] });

                try {
                    const promises = Array.from({ length: slot.variations }).map(async () => {
                        let requestBody;
                        let apiUrl;
                        
                        // Check if using Imagen models (different API)
                        if (selectedModel.startsWith('imagen')) {
                            apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:predict?key=${apiKey}`;
                            requestBody = {
                                instances: [{ prompt: slot.prompt }],
                                parameters: {
                                    sampleCount: 1,
                                    aspectRatio: slot.aspectRatio !== 'auto' ? slot.aspectRatio : '1:1'
                                }
                            };
                        } else {
                            // Gemini models use generateContent
                            apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                            requestBody = {
                                contents: [{ parts: [{ text: `Generate an image: ${slot.prompt}` }] }],
                                generationConfig: {
                                    responseModalities: ['IMAGE', 'TEXT']
                                }
                            };
                        }
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('API Error:', errorData);
                            throw new Error(errorData.error?.message || 'Failed to generate image');
                        }

                        const data = await response.json();
                        console.log('Generate API response:', JSON.stringify(data, null, 2));
                        
                        // Handle Imagen response format
                        if (selectedModel.startsWith('imagen')) {
                            if (data.predictions?.[0]?.bytesBase64Encoded) {
                                return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                            }
                        }
                        
                        // Handle Gemini response format
                        const parts = data.candidates?.[0]?.content?.parts || [];
                        
                        // Look for image data in parts
                        for (const part of parts) {
                            if (part.inlineData?.data) {
                                const mimeType = part.inlineData.mimeType || 'image/png';
                                return `data:${mimeType};base64,${part.inlineData.data}`;
                            }
                        }
                        
                        // Check for text response (might indicate why image wasn't generated)
                        const textPart = parts.find(p => p.text);
                        if (textPart) {
                            console.log('API returned text instead of image:', textPart.text);
                            throw new Error(`Model response: ${textPart.text.substring(0, 150)}`);
                        }
                        
                        throw new Error('No image data in API response. This model may not support image generation. Try gemini-2.0-flash-exp-image-generation.');
                    });

                    const results = await Promise.all(promises);
                    
                    const historyEntry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        mode: 'generate',
                        prompt: slot.prompt,
                        sourceImage: null,
                        results: results,
                        aspectRatio: slot.aspectRatio,
                        resolution: slot.resolution
                    };
                    addToHistory(historyEntry);
                    
                    updateGenSlot(index, { results, loading: false });
                } catch (err) {
                    console.error('Generation error:', err);
                    updateGenSlot(index, { error: err.message || 'Failed to generate', loading: false });
                }
            };
            
            const processAllGenSlots = async () => {
                const slotsToProcess = genSlotsArray
                    .slice(0, visibleGenSlots)
                    .map((slot, idx) => ({ ...slot, index: idx }))
                    .filter(slot => slot.prompt.trim());
                
                if (slotsToProcess.length === 0) {
                    alert('Please add at least one prompt');
                    return;
                }
                
                await Promise.all(slotsToProcess.map(slot => processGenSlot(slot.index)));
            };
            
            const downloadGenSlotImage = (slotIndex, resultIndex) => {
                const result = genSlotsArray[slotIndex]?.results?.[resultIndex];
                if (!result) return;
                const link = document.createElement('a');
                link.href = result;
                link.download = `generated-slot${slotIndex + 1}-${resultIndex + 1}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const downloadAllGenSlotImages = (slotIndex) => {
                const slot = genSlotsArray[slotIndex];
                if (!slot?.results?.length) return;
                slot.results.forEach((result, idx) => {
                    setTimeout(() => downloadGenSlotImage(slotIndex, idx), idx * 200);
                });
            };
            
            const getActiveGenCount = () => genSlotsArray.slice(0, visibleGenSlots).filter(s => s.prompt.trim()).length;
            const getCompletedGenCount = () => genSlotsArray.slice(0, visibleGenSlots).filter(s => s.results?.length > 0).length;

            // === MULTI-IMAGE EDIT MODE FUNCTIONS ===
            const handleMultiDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setMultiDragActive(true);
                } else if (e.type === "dragleave") {
                    setMultiDragActive(false);
                }
            };

            const handleMultiDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setMultiDragActive(false);
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );

                if (files.length === 0) return;

                // Allow up to 10 images total
                const remainingSlots = 10 - multiImages.length;
                const filesToProcess = files.slice(0, remainingSlots);

                const promises = filesToProcess.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            // Auto-add to collection
                            addToCollection(reader.result, file.name);
                            resolve({
                                base64: reader.result.split(',')[1],
                                preview: reader.result,
                                file: file
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(newImages => {
                    setMultiImages(prev => [...prev, ...newImages]);
                    if (multiImages.length === 0) {
                        setMultiResults([]);
                        setMultiError(null);
                    }
                });

                if (files.length > remainingSlots) {
                    alert(`Added ${filesToProcess.length} images. ${files.length - filesToProcess.length} skipped (max 20 images total)`);
                }
            };

            const handleMultiFileSelect = (e) => {
                const files = Array.from(e.target.files || []).filter(file => 
                    file.type.startsWith('image/')
                );

                if (files.length === 0) return;

                // Allow up to 10 images total
                const remainingSlots = 10 - multiImages.length;
                const filesToProcess = files.slice(0, remainingSlots);

                const promises = filesToProcess.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            // Auto-add to collection
                            addToCollection(reader.result, file.name);
                            resolve({
                                base64: reader.result.split(',')[1],
                                preview: reader.result,
                                file: file
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(newImages => {
                    setMultiImages(prev => [...prev, ...newImages]);
                    if (multiImages.length === 0) {
                        setMultiResults([]);
                        setMultiError(null);
                    }
                });

                if (files.length > remainingSlots) {
                    alert(`Added ${filesToProcess.length} images. ${files.length - filesToProcess.length} skipped (max 20 images total)`);
                }
            };

            const removeMultiImage = (index) => {
                setMultiImages(prev => prev.filter((_, i) => i !== index));
                setMultiResults(prev => prev.filter((_, i) => i !== index));
            };

            const processMultiImages = async () => {
                if (!apiKey) {
                    setSettingsOpen(true);
                    return;
                }
                
                if (multiImages.length === 0) {
                    setMultiError('Please upload at least one image');
                    return;
                }

                if (!multiPrompt.trim()) {
                    setMultiError('Please enter a prompt');
                    return;
                }

                setMultiLoading(true);
                setMultiError(null);
                setMultiResults([]);

                const imageConfig = { imageSize: multiResolution };
                if (multiAspectRatio !== 'auto') {
                    imageConfig.aspectRatio = multiAspectRatio;
                }

                try {
                    // For each input image, generate multiSlots variations
                    const promises = multiImages.flatMap((img) => 
                        Array.from({ length: multiSlots }).map(async () => {
                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{
                                            parts: [
                                                { text: multiPrompt },
                                                { inline_data: { mime_type: 'image/jpeg', data: img.base64 } }
                                            ]
                                        }],
                                        generationConfig: {
                                            responseModalities: ['IMAGE'],
                                            imageConfig: imageConfig
                                        }
                                    })
                                }
                            );

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error?.message || 'Failed to process image');
                            }

                            const data = await response.json();
                            
                            if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                                return `data:image/jpeg;base64,${data.candidates[0].content.parts[0].inlineData.data}`;
                            } else {
                                throw new Error('Invalid response format');
                            }
                        })
                    );

                    const results = await Promise.all(promises);
                    setMultiResults(results);
                    
                    // Save to history
                    const historyEntry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        mode: 'multi',
                        prompt: multiPrompt,
                        sourceImage: multiImages[0]?.preview || null,
                        sourceCount: multiImages.length,
                        results: results,
                        aspectRatio: multiAspectRatio,
                        resolution: multiResolution
                    };
                    addToHistory(historyEntry);
                } catch (err) {
                    setMultiError(err.message || 'Failed to process images');
                } finally {
                    setMultiLoading(false);
                }
            };

            const downloadMultiImage = (index) => {
                if (!multiResults[index]) return;
                const link = document.createElement('a');
                link.href = multiResults[index];
                link.download = `multi-edit-${index + 1}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const downloadAllMulti = () => {
                multiResults.forEach((result, idx) => {
                    setTimeout(() => downloadMultiImage(idx), idx * 200);
                });
            };

            const clearMultiImages = () => {
                setMultiImages([]);
                setMultiResults([]);
                setMultiError(null);
                if (multiFileInputRef.current) {
                    multiFileInputRef.current.value = '';
                }
            };

            // === MULTI-SLOT FUNCTIONS FOR MULTI-IMAGE EDIT ===
            const updateMultiSlot = (index, updates) => {
                setMultiSlotsArray(prev => prev.map((slot, i) => 
                    i === index ? { ...slot, ...updates } : slot
                ));
            };

            const addImageToMultiSlot = (index, imageData) => {
                setMultiSlotsArray(prev => prev.map((slot, i) => 
                    i === index ? { ...slot, images: [...slot.images, imageData] } : slot
                ));
            };

            const removeImageFromMultiSlot = (slotIndex, imageIndex) => {
                setMultiSlotsArray(prev => prev.map((slot, i) => 
                    i === slotIndex ? { ...slot, images: slot.images.filter((_, idx) => idx !== imageIndex) } : slot
                ));
            };

            const clearMultiSlot = (index) => {
                setMultiSlotsArray(prev => prev.map((slot, i) => 
                    i === index ? { ...slot, images: [], results: [], error: null } : slot
                ));
            };

            const handleMultiSlotDrop = (slotIndex, e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );
                if (files.length === 0) return;

                const currentSlot = multiSlotsArray[slotIndex];
                const remainingSlots = 20 - currentSlot.images.length;
                const filesToProcess = files.slice(0, remainingSlots);

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        addToCollection(reader.result, file.name);
                        addImageToMultiSlot(slotIndex, {
                            id: generateUniqueId(),
                            base64: reader.result.split(',')[1],
                            preview: reader.result,
                            fileName: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleMultiSlotFileSelect = (slotIndex, e) => {
                const files = Array.from(e.target.files || []).filter(file => 
                    file.type.startsWith('image/')
                );
                if (files.length === 0) return;

                const currentSlot = multiSlotsArray[slotIndex];
                const remainingSlots = 20 - currentSlot.images.length;
                const filesToProcess = files.slice(0, remainingSlots);

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        addToCollection(reader.result, file.name);
                        addImageToMultiSlot(slotIndex, {
                            id: generateUniqueId(),
                            base64: reader.result.split(',')[1],
                            preview: reader.result,
                            fileName: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = '';
            };

            const processMultiSlot = async (slotIndex) => {
                const slot = multiSlotsArray[slotIndex];
                if (slot.images.length === 0 || !slot.prompt.trim()) return;
                if (!apiKey) { setSettingsOpen(true); return; }

                updateMultiSlot(slotIndex, { loading: true, error: null, results: [] });

                try {
                    const results = [];
                    for (const img of slot.images) {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            { inlineData: { mimeType: 'image/jpeg', data: img.base64 } },
                                            { text: slot.prompt }
                                        ]
                                    }],
                                    generationConfig: { responseModalities: ['image', 'text'] }
                                })
                            }
                        );

                        const data = await response.json();
                        if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                            results.push(`data:image/jpeg;base64,${data.candidates[0].content.parts[0].inlineData.data}`);
                        }
                    }
                    
                    updateMultiSlot(slotIndex, { loading: false, results });
                    
                    // Add to history
                    const entry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        mode: 'multi',
                        prompt: slot.prompt,
                        inputs: slot.images.map(img => img.preview),
                        results
                    };
                    addToHistory(entry);
                } catch (error) {
                    updateMultiSlot(slotIndex, { loading: false, error: error.message });
                }
            };

            const processAllMultiSlots = async () => {
                const activeSlots = multiSlotsArray
                    .slice(0, visibleMultiSlots)
                    .map((slot, index) => ({ slot, index }))
                    .filter(({ slot }) => slot.images.length > 0 && slot.prompt.trim());
                
                for (const { index } of activeSlots) {
                    await processMultiSlot(index);
                }
            };

            const getActiveMultiCount = () => multiSlotsArray.slice(0, visibleMultiSlots).filter(s => s.images.length > 0 && s.prompt.trim()).length;
            const getCompletedMultiCount = () => multiSlotsArray.slice(0, visibleMultiSlots).filter(s => s.results?.length > 0).length;

            // === MULTI-IMAGE GENERATOR (COMBINE) MODE FUNCTIONS ===
            const handleCombineDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setCombineDragActive(true);
                } else if (e.type === "dragleave") {
                    setCombineDragActive(false);
                }
            };

            const handleCombineDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setCombineDragActive(false);
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );

                if (files.length === 0) return;

                // Calculate how many more images we can add (max 20 total)
                const remainingSlots = 8 - combineImages.length;
                const filesToProcess = files.slice(0, remainingSlots);

                const promises = filesToProcess.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            // Auto-add to collection
                            addToCollection(reader.result, file.name);
                            resolve({
                                base64: reader.result.split(',')[1],
                                preview: reader.result,
                                file: file
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(newImages => {
                    setCombineImages(prev => [...prev, ...newImages]);
                    if (combineImages.length === 0) {
                        setCombineResults([]);
                        setCombineError(null);
                    }
                });

                if (files.length > remainingSlots) {
                    alert(`Added ${filesToProcess.length} images. ${files.length - filesToProcess.length} skipped (max 20 images total)`);
                }
            };

            const handleCombineFileSelect = (e) => {
                const files = Array.from(e.target.files || []).filter(file => 
                    file.type.startsWith('image/')
                );

                if (files.length === 0) return;

                // Calculate how many more images we can add (max 20 total)
                const remainingSlots = 8 - combineImages.length;
                const filesToProcess = files.slice(0, remainingSlots);

                const promises = filesToProcess.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            // Auto-add to collection
                            addToCollection(reader.result, file.name);
                            resolve({
                                base64: reader.result.split(',')[1],
                                preview: reader.result,
                                file: file
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(newImages => {
                    setCombineImages(prev => [...prev, ...newImages]);
                    if (combineImages.length === 0) {
                        setCombineResults([]);
                        setCombineError(null);
                    }
                });

                if (files.length > remainingSlots) {
                    alert(`Added ${filesToProcess.length} images. ${files.length - filesToProcess.length} skipped (max 20 images total)`);
                }
            };

            const removeCombineImage = (index) => {
                setCombineImages(prev => prev.filter((_, i) => i !== index));
            };

            const combineMergeImages = async () => {
                if (!apiKey) {
                    setSettingsOpen(true);
                    return;
                }
                
                if (combineImages.length < 2) {
                    setCombineError('Please upload at least 2 images to combine');
                    return;
                }

                if (!combinePrompt.trim()) {
                    setCombineError('Please enter a prompt describing how to combine the images');
                    return;
                }

                setCombineLoading(true);
                setCombineError(null);
                setCombineResults([]);

                const imageConfig = { imageSize: combineResolution };
                if (combineAspectRatio !== 'auto') {
                    imageConfig.aspectRatio = combineAspectRatio;
                }

                try {
                    // Generate combineSlots number of combined images
                    const promises = Array.from({ length: combineSlots }).map(async () => {
                        // Build the parts array: prompt first, then all images
                        const parts = [
                            { text: combinePrompt },
                            ...combineImages.map(img => ({
                                inline_data: { mime_type: 'image/jpeg', data: img.base64 }
                            }))
                        ];

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts }],
                                    generationConfig: {
                                        responseModalities: ['IMAGE'],
                                        imageConfig: imageConfig
                                    }
                                })
                            }
                        );

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Failed to combine images');
                        }

                        const data = await response.json();
                        
                        if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                            return `data:image/jpeg;base64,${data.candidates[0].content.parts[0].inlineData.data}`;
                        } else {
                            throw new Error('Invalid response format');
                        }
                    });

                    const results = await Promise.all(promises);
                    setCombineResults(results);
                    
                    // Save to history
                    const historyEntry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        mode: 'combine',
                        prompt: combinePrompt,
                        sourceImage: combineImages[0]?.preview || null,
                        sourceCount: combineImages.length,
                        results: results,
                        aspectRatio: combineAspectRatio,
                        resolution: combineResolution
                    };
                    addToHistory(historyEntry);
                } catch (err) {
                    setCombineError(err.message || 'Failed to combine images');
                } finally {
                    setCombineLoading(false);
                }
            };

            const downloadCombined = (index) => {
                if (!combineResults[index]) return;
                const link = document.createElement('a');
                link.href = combineResults[index];
                link.download = `combined-image-${index + 1}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const downloadAllCombined = () => {
                combineResults.forEach((result, idx) => {
                    setTimeout(() => downloadCombined(idx), idx * 200);
                });
            };

            const clearCombineImages = () => {
                setCombineImages([]);
                setCombineResults([]);
                setCombineError(null);
                if (combineFileInputRef.current) {
                    combineFileInputRef.current.value = '';
                }
            };

            // === MULTI-SLOT FUNCTIONS FOR COMBINE MODE ===
            const updateCombineSlot = (index, updates) => {
                setCombineSlotsArray(prev => prev.map((slot, i) => 
                    i === index ? { ...slot, ...updates } : slot
                ));
            };

            const addImageToCombineSlot = (index, imageData) => {
                setCombineSlotsArray(prev => prev.map((slot, i) => 
                    i === index ? { ...slot, images: [...slot.images, imageData] } : slot
                ));
            };

            const removeImageFromCombineSlot = (slotIndex, imageIndex) => {
                setCombineSlotsArray(prev => prev.map((slot, i) => 
                    i === slotIndex ? { ...slot, images: slot.images.filter((_, idx) => idx !== imageIndex) } : slot
                ));
            };

            const clearCombineSlot = (index) => {
                setCombineSlotsArray(prev => prev.map((slot, i) => 
                    i === index ? { ...slot, images: [], results: [], error: null } : slot
                ));
            };

            const handleCombineSlotDrop = (slotIndex, e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );
                if (files.length === 0) return;

                const currentSlot = combineSlotsArray[slotIndex];
                const remainingSlots = 20 - currentSlot.images.length;
                const filesToProcess = files.slice(0, remainingSlots);

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        addToCollection(reader.result, file.name);
                        addImageToCombineSlot(slotIndex, {
                            id: generateUniqueId(),
                            base64: reader.result.split(',')[1],
                            preview: reader.result,
                            fileName: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleCombineSlotFileSelect = (slotIndex, e) => {
                const files = Array.from(e.target.files || []).filter(file => 
                    file.type.startsWith('image/')
                );
                if (files.length === 0) return;

                const currentSlot = combineSlotsArray[slotIndex];
                const remainingSlots = 20 - currentSlot.images.length;
                const filesToProcess = files.slice(0, remainingSlots);

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        addToCollection(reader.result, file.name);
                        addImageToCombineSlot(slotIndex, {
                            id: generateUniqueId(),
                            base64: reader.result.split(',')[1],
                            preview: reader.result,
                            fileName: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = '';
            };

            const processCombineSlot = async (slotIndex) => {
                const slot = combineSlotsArray[slotIndex];
                if (slot.images.length < 2 || !slot.prompt.trim()) return;
                if (!apiKey) { setSettingsOpen(true); return; }

                updateCombineSlot(slotIndex, { loading: true, error: null, results: [] });

                try {
                    const imageParts = slot.images.map(img => ({
                        inlineData: { mimeType: 'image/jpeg', data: img.base64 }
                    }));

                    const results = [];
                    for (let i = 0; i < slot.variations; i++) {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [...imageParts, { text: slot.prompt }]
                                    }],
                                    generationConfig: { responseModalities: ['image', 'text'] }
                                })
                            }
                        );

                        const data = await response.json();
                        if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                            results.push(`data:image/jpeg;base64,${data.candidates[0].content.parts[0].inlineData.data}`);
                        }
                    }
                    
                    updateCombineSlot(slotIndex, { loading: false, results });
                    
                    // Add to history
                    const entry = {
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        mode: 'combine',
                        prompt: slot.prompt,
                        sourceImage: slot.images[0]?.preview || null,
                        sourceCount: slot.images.length,
                        results
                    };
                    addToHistory(entry);
                } catch (error) {
                    updateCombineSlot(slotIndex, { loading: false, error: error.message });
                }
            };

            const processAllCombineSlots = async () => {
                const activeSlots = combineSlotsArray
                    .slice(0, visibleCombineSlots)
                    .map((slot, index) => ({ slot, index }))
                    .filter(({ slot }) => slot.images.length >= 2 && slot.prompt.trim());
                
                for (const { index } of activeSlots) {
                    await processCombineSlot(index);
                }
            };

            const getActiveCombineCount = () => combineSlotsArray.slice(0, visibleCombineSlots).filter(s => s.images.length >= 2 && s.prompt.trim()).length;
            const getCompletedCombineCount = () => combineSlotsArray.slice(0, visibleCombineSlots).filter(s => s.results?.length > 0).length;

            const handleModeChange = (newMode) => {
                setMode(newMode);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* IndexedDB Initialization Status */}
                        {!dbReady && !dbError && (
                            <div className="fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50">
                                <Loader2 className="w-5 h-5 animate-spin" />
                                <span>Initializing storage...</span>
                            </div>
                        )}
                        
                        {dbError && (
                            <div className="fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50">
                                <X className="w-5 h-5" />
                                <span>Storage error: {dbError}</span>
                            </div>
                        )}
                        
                        {/* Header with Mode Tabs */}
                        <div className="text-center mb-8">
                            <div className="flex items-center justify-center gap-3 mb-4 relative">
                                <span className="text-5xl">üçå</span>
                                <h1 className="text-4xl font-bold text-white">Nana Banana Pro Unleashed</h1>
                                <div className="absolute right-0 flex gap-2">
                                    <button
                                        onClick={cycleVolume}
                                        className={`p-3 rounded-lg transition-all ${
                                            soundVolume === 'normal' ? 'bg-green-600 hover:bg-green-500 text-white' :
                                            soundVolume === 'low' ? 'bg-amber-600 hover:bg-amber-500 text-white' :
                                            'bg-slate-700 hover:bg-slate-600 text-slate-400'
                                        }`}
                                        title={
                                            soundVolume === 'normal' ? 'Volume: Normal (click for Off)' :
                                            soundVolume === 'low' ? 'Volume: Low (click for Normal)' :
                                            'Volume: Off (click for Low)'
                                        }
                                    >
                                        {soundVolume === 'normal' ? <Volume2 className="w-5 h-5" /> :
                                         soundVolume === 'low' ? <Volume1 className="w-5 h-5" /> :
                                         <VolumeX className="w-5 h-5" />}
                                    </button>
                                    <button
                                        onClick={() => setSettingsOpen(true)}
                                        className={`p-3 rounded-lg transition-all ${
                                            apiKey 
                                                ? 'bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-white' 
                                                : 'bg-amber-500 hover:bg-amber-600 text-white animate-pulse'
                                        }`}
                                        title={apiKey ? 'API Settings' : 'Configure your API key'}
                                    >
                                        <Settings className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                            <p className="text-slate-500 text-xs mb-2">
                                Created by: <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank" rel="noopener noreferrer" className="text-amber-500 hover:text-amber-400 hover:underline">MW</a>
                            </p>
                            
                            {/* API Key Warning Banner */}
                            {!apiKey && (
                                <div 
                                    onClick={() => setSettingsOpen(true)}
                                    className="mb-4 bg-amber-500/20 border border-amber-500/50 rounded-lg p-3 cursor-pointer hover:bg-amber-500/30 transition-colors"
                                >
                                    <div className="flex items-center justify-center gap-2 text-amber-300">
                                        <Key className="w-5 h-5" />
                                        <span className="font-medium">Click here to configure your Gemini API key to get started</span>
                                    </div>
                                </div>
                            )}

                            {/* Mode Tabs */}
                            <div className="flex gap-3 justify-center mb-6 flex-wrap">
                                <button
                                    onClick={() => handleModeChange('analyze')}
                                    className={`mode-tab px-6 py-3 rounded-lg font-semibold text-white flex items-center gap-2 ${
                                        mode === 'analyze' ? 'active analyze-tab' : 'bg-slate-700 hover:bg-slate-600'
                                    }`}
                                >
                                    <Search className="w-5 h-5" />
                                    Analyze
                                </button>
                                <button
                                    onClick={() => handleModeChange('edit')}
                                    className={`mode-tab px-6 py-3 rounded-lg font-semibold text-white flex items-center gap-2 ${
                                        mode === 'edit' ? 'active' : 'bg-slate-700 hover:bg-slate-600'
                                    }`}
                                >
                                    <Camera className="w-5 h-5" />
                                    Image Editor
                                </button>
                                <button
                                    onClick={() => handleModeChange('combine')}
                                    className={`mode-tab px-6 py-3 rounded-lg font-semibold text-white flex items-center gap-2 ${
                                        mode === 'combine' ? 'active' : 'bg-slate-700 hover:bg-slate-600'
                                    }`}
                                >
                                    <Zap className="w-5 h-5" />
                                    Multi-Image Generator
                                </button>
                                <button
                                    onClick={() => handleModeChange('multi')}
                                    className={`mode-tab px-6 py-3 rounded-lg font-semibold text-white flex items-center gap-2 ${
                                        mode === 'multi' ? 'active' : 'bg-slate-700 hover:bg-slate-600'
                                    }`}
                                >
                                    <Upload className="w-5 h-5" />
                                    Multi-Image Edit
                                </button>
                                <button
                                    onClick={() => handleModeChange('generate')}
                                    className={`mode-tab px-6 py-3 rounded-lg font-semibold text-white flex items-center gap-2 ${
                                        mode === 'generate' ? 'active' : 'bg-slate-700 hover:bg-slate-600'
                                    }`}
                                >
                                    <Sparkles className="w-5 h-5" />
                                    Image Generator
                                </button>
                            </div>
                        </div>

                        {/* ANALYZE MODE */}
                        <div className={mode === 'analyze' ? '' : 'hidden'}>
                            <div className="max-w-4xl mx-auto">
                                <p className="text-slate-400 text-lg mb-6 text-center">
                                    Analyze images with AI vision, then transfer descriptions to the editor
                                </p>

                                {/* Image Collection Dropdown */}
                                <div className="mb-6">
                                    <button
                                        onClick={() => setCollectionOpen(!collectionOpen)}
                                        className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                                    >
                                        <div className="flex items-center gap-3">
                                            <Folder className="w-5 h-5 text-purple-500" />
                                            <span className="text-white font-medium">Image Collection</span>
                                            <span className="text-slate-400 text-sm">
                                                {uploadedCollection.length} image{uploadedCollection.length !== 1 ? 's' : ''}
                                            </span>
                                        </div>
                                        <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${collectionOpen ? 'rotate-180' : ''}`} />
                                    </button>
                                    {collectionOpen && (
                                        <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                            <div className="flex items-center justify-between mb-3">
                                                <p className="text-slate-400 text-sm">Click + to add images to analysis queue</p>
                                                {uploadedCollection.length > 0 && (
                                                    <button
                                                        onClick={clearCollection}
                                                        className="text-red-400 hover:text-red-300 text-xs flex items-center gap-1"
                                                    >
                                                        <Trash className="w-3 h-3" /> Clear All
                                                    </button>
                                                )}
                                            </div>
                                            {uploadedCollection.length > 0 ? (
                                                <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2">
                                                    {uploadedCollection.map((img) => (
                                                        <div key={img.id} className="relative group cursor-pointer" onClick={() => openImageModal(img.preview, img.fileName)}>
                                                            <img src={img.preview} alt={img.fileName} className="w-full aspect-square object-cover rounded border border-slate-600 hover:border-purple-500 transition-colors" />
                                                            <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center gap-1">
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); useFromCollectionForAnalyze(img); }}
                                                                    className="bg-purple-500 hover:bg-purple-600 text-white p-1 rounded"
                                                                    title="Add to analysis"
                                                                >
                                                                    <Plus className="w-2.5 h-2.5" />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); removeFromCollection(img.id); }}
                                                                    className="bg-red-500 hover:bg-red-600 text-white p-1 rounded"
                                                                    title="Remove from collection"
                                                                >
                                                                    <X className="w-2.5 h-2.5" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <p className="text-slate-500 text-sm text-center">No images in collection. Upload images to build your collection.</p>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Analyze Card */}
                                <div className="bg-slate-800 rounded-xl p-6 border border-purple-500/30 shadow-xl">
                                    <h3 className="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                                        <Search className="w-6 h-6 text-purple-400" />
                                        Vision Analysis
                                    </h3>

                                    {/* Upload Area */}
                                    {analyzeImages.length < 10 && (
                                        <div
                                            className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-all mb-6 ${
                                                analyzeDragActive 
                                                    ? 'border-purple-500 bg-purple-500/10' 
                                                    : 'border-slate-600 hover:border-purple-500'
                                            }`}
                                            onClick={() => analyzeFileInputRef.current?.click()}
                                            onDragEnter={handleAnalyzeDrag}
                                            onDragOver={handleAnalyzeDrag}
                                            onDragLeave={handleAnalyzeDrag}
                                            onDrop={handleAnalyzeDrop}
                                        >
                                            <Upload className="w-12 h-12 text-purple-400 mx-auto mb-3" />
                                            <p className="text-slate-300 mb-1">Drop images here or click to upload</p>
                                            <p className="text-slate-500 text-sm">Up to 10 images ‚Ä¢ JPG, PNG, WebP</p>
                                            <input
                                                ref={analyzeFileInputRef}
                                                type="file"
                                                multiple
                                                className="hidden"
                                                accept="image/*"
                                                onChange={handleAnalyzeFileSelect}
                                            />
                                        </div>
                                    )}

                                    {/* Uploaded Images Grid */}
                                    {analyzeImages.length > 0 && (
                                        <div className="mb-6">
                                            <div className="flex items-center justify-between mb-3">
                                                <span className="text-slate-300 font-medium">{analyzeImages.length} image{analyzeImages.length !== 1 ? 's' : ''} ready</span>
                                                <button
                                                    onClick={clearAnalyzeImages}
                                                    className="text-red-400 hover:text-red-300 text-sm flex items-center gap-1"
                                                >
                                                    <X className="w-4 h-4" /> Clear All
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-5 gap-3">
                                                {analyzeImages.map((img) => (
                                                    <div key={img.id} className="relative group">
                                                        <img
                                                            src={img.preview}
                                                            alt={img.fileName}
                                                            className="w-full aspect-square object-cover rounded-lg border-2 border-purple-500/50 cursor-pointer"
                                                            onClick={() => openImageModal(img.preview, img.fileName)}
                                                        />
                                                        <button
                                                            onClick={() => removeAnalyzeImage(img.id)}
                                                            className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                                        >
                                                            <X className="w-3 h-3" />
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Prompt */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Analysis Prompt</label>
                                        <textarea
                                            value={analyzePrompt}
                                            onChange={(e) => setAnalyzePrompt(e.target.value)}
                                            placeholder="What would you like to know about these images?"
                                            className="w-full bg-slate-900 text-white rounded-lg p-4 border border-slate-600 focus:border-purple-500 focus:outline-none resize-none h-24"
                                        />
                                    </div>

                                    {/* Analyze Button */}
                                    <button
                                        onClick={processAnalysis}
                                        disabled={analyzeLoading || analyzeImages.length === 0 || !analyzePrompt.trim()}
                                        className="w-full bg-gradient-to-r from-purple-500 to-violet-500 hover:from-purple-600 hover:to-violet-600 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3 shadow-lg text-lg"
                                    >
                                        {analyzeLoading ? (
                                            <>
                                                <Loader2 className="w-6 h-6 animate-spin" />
                                                Analyzing {analyzeImages.length} image{analyzeImages.length !== 1 ? 's' : ''}...
                                            </>
                                        ) : (
                                            <>
                                                <Search className="w-6 h-6" />
                                                Analyze {analyzeImages.length > 0 ? analyzeImages.length : ''} Image{analyzeImages.length !== 1 ? 's' : ''}
                                            </>
                                        )}
                                    </button>

                                    {/* Error */}
                                    {analyzeError && (
                                        <div className="mt-4 bg-red-500/20 border border-red-500/50 rounded-lg p-4 text-red-300">
                                            {analyzeError}
                                        </div>
                                    )}

                                    {/* Results */}
                                    {analyzeResults.length > 0 && !analyzeLoading && (
                                        <div className="mt-8 pt-8 border-t border-slate-700">
                                            <div className="flex items-center justify-between mb-6">
                                                <h3 className="text-xl font-semibold text-white flex items-center gap-2">
                                                    <CheckCircle className="w-6 h-6 text-green-400" />
                                                    Analysis Complete
                                                </h3>
                                                <button
                                                    onClick={transferAllToEditor}
                                                    className="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"
                                                >
                                                    <ArrowRight className="w-4 h-4" />
                                                    Transfer All to Editor
                                                </button>
                                            </div>
                                            
                                            <div className="space-y-6">
                                                {analyzeResults.map((result, idx) => (
                                                    <div key={result.id} className="bg-slate-900 rounded-lg p-4 border border-slate-700">
                                                        <div className="flex gap-4">
                                                            <img
                                                                src={result.preview}
                                                                alt={result.fileName}
                                                                className="w-32 h-32 object-cover rounded-lg border border-slate-600 flex-shrink-0 cursor-pointer hover:border-purple-500"
                                                                onClick={() => openImageModal(result.preview, result.fileName)}
                                                            />
                                                            <div className="flex-1">
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <span className="text-purple-400 font-medium">Image {idx + 1}: {result.fileName}</span>
                                                                    <button
                                                                        onClick={() => transferToEditor(result)}
                                                                        className="bg-amber-500 hover:bg-amber-600 text-white text-sm py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5"
                                                                    >
                                                                        <ArrowRight className="w-3 h-3" />
                                                                        To Editor
                                                                    </button>
                                                                </div>
                                                                <p className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap max-h-48 overflow-y-auto">
                                                                    {result.analysis}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Analysis History */}
                                <div className="mt-8">
                                    <button
                                        onClick={() => setAnalysisHistoryOpen(!analysisHistoryOpen)}
                                        className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                                    >
                                        <div className="flex items-center gap-3">
                                            <Clock className="w-5 h-5 text-purple-500" />
                                            <span className="text-white font-medium">Analysis History</span>
                                            <span className="text-slate-400 text-sm">
                                                {analysisHistory.length} entr{analysisHistory.length !== 1 ? 'ies' : 'y'}
                                            </span>
                                        </div>
                                        <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${analysisHistoryOpen ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {analysisHistoryOpen && (
                                        <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                            <div className="flex items-center justify-between mb-4">
                                                <p className="text-slate-400 text-sm">Last {analysisHistory.length} analyses</p>
                                                {analysisHistory.length > 0 && (
                                                    <button
                                                        onClick={clearAnalysisHistory}
                                                        className="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                                    >
                                                        <Trash className="w-3 h-3" /> Clear
                                                    </button>
                                                )}
                                            </div>
                                            {analysisHistory.length > 0 ? (
                                                <div className="space-y-3 max-h-96 overflow-y-auto">
                                                    {analysisHistory.map((entry) => (
                                                        <div key={entry.id} className="bg-slate-900 rounded-lg p-3 border border-slate-700">
                                                            <div className="flex items-start justify-between mb-2">
                                                                <div>
                                                                    <span className="text-purple-400 text-xs bg-purple-500/20 px-2 py-0.5 rounded-full">Analyze</span>
                                                                    <span className="text-slate-500 text-xs ml-2">{new Date(entry.timestamp).toLocaleString()}</span>
                                                                </div>
                                                                <button onClick={() => removeFromAnalysisHistory(entry.id)} className="text-slate-500 hover:text-red-400 p-1">
                                                                    <X className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                            <p className="text-slate-300 text-sm line-clamp-2 mb-2">{entry.prompt}</p>
                                                            <div className="flex gap-2 overflow-x-auto">
                                                                {entry.images?.slice(0, 5).map((img, idx) => (
                                                                    <img key={idx} src={img.preview} alt="" className="w-12 h-12 object-cover rounded border border-slate-600 flex-shrink-0" />
                                                                ))}
                                                                {entry.images?.length > 5 && (
                                                                    <div className="w-12 h-12 rounded border border-slate-600 bg-slate-700 flex items-center justify-center text-slate-400 text-xs flex-shrink-0">
                                                                        +{entry.images.length - 5}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <p className="text-slate-500 text-sm text-center py-4">No analysis history yet.</p>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* EDIT MODE */}
                        <div className={mode === 'edit' ? '' : 'hidden'}>
                            <p className="text-slate-400 text-lg mb-4 text-center">
                                Edit multiple images simultaneously with individual settings
                            </p>
                            
                                
                                {/* Bulk Upload Zone - Collapsible */}
                                <div className="mb-4">
                                    <button
                                        onClick={() => setBulkSectionOpen(!bulkSectionOpen)}
                                        className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                                    >
                                        <div className="flex items-center gap-3">
                                            <Upload className="w-5 h-5 text-amber-500" />
                                            <span className="text-white font-medium">Drop Multiple Images</span>
                                            <span className="text-slate-400 text-sm">Fill slots quickly</span>
                                        </div>
                                        <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${bulkSectionOpen ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {bulkSectionOpen && (
                                        <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                            {/* Drop zone for slots */}
                                            <div
                                                className={`border-2 border-dashed rounded-lg p-6 transition-all ${
                                                    bulkDragActive
                                                        ? 'border-amber-500 bg-amber-500/10'
                                                        : 'border-slate-600 hover:border-slate-500'
                                                }`}
                                                onDragEnter={handleBulkDrag}
                                                onDragLeave={handleBulkDrag}
                                                onDragOver={handleBulkDrag}
                                                onDrop={handleBulkDrop}
                                            >
                                                <div className="text-center">
                                                    <Upload className="w-8 h-8 text-amber-500 mx-auto mb-2" />
                                                    <p className="text-white font-semibold mb-1 text-sm">
                                                        Drop Images to Fill Slots
                                                    </p>
                                                    <p className="text-slate-400 text-xs mb-2">
                                                        Drag and drop images to auto-fill available slots (auto-expands as needed)
                                                    </p>
                                                    {getAvailableSlots() < visibleSlots && (
                                                        <p className="text-amber-400 text-xs">
                                                            {getAvailableSlots()} slot{getAvailableSlots() !== 1 ? 's' : ''} available
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Duplicate Image Section - Collapsible */}
                                <div className="mb-4">
                                    <button
                                        onClick={() => setDuplicateSectionOpen(!duplicateSectionOpen)}
                                        className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                                    >
                                        <div className="flex items-center gap-3">
                                            <Camera className="w-5 h-5 text-blue-500" />
                                            <span className="text-white font-medium">Duplicate One Image</span>
                                            <span className="text-slate-400 text-sm">Fill multiple slots with copies</span>
                                        </div>
                                        <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${duplicateSectionOpen ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {duplicateSectionOpen && (
                                        <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                            <div className="grid md:grid-cols-3 gap-4 items-end">
                                                {/* Upload */}
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-300 mb-2">
                                                        Image to Duplicate
                                                    </label>
                                                    {!duplicatePreview ? (
                                                        <div
                                                            className={`border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition-all ${
                                                                duplicateDragActive
                                                                    ? 'border-blue-500 bg-blue-500/10'
                                                                    : 'border-slate-600 hover:border-slate-500'
                                                            }`}
                                                            onClick={() => duplicateInputRef.current?.click()}
                                                            onDragEnter={handleDuplicateDrag}
                                                            onDragLeave={handleDuplicateDrag}
                                                            onDragOver={handleDuplicateDrag}
                                                            onDrop={handleDuplicateDrop}
                                                        >
                                                            <Upload className="w-6 h-6 text-slate-400 mx-auto mb-1" />
                                                            <p className="text-slate-300 text-xs">Click or drag image</p>
                                                            <input
                                                                ref={duplicateInputRef}
                                                                type="file"
                                                                className="hidden"
                                                                accept="image/*"
                                                                onChange={(e) => e.target.files?.[0] && handleDuplicateFile(e.target.files[0])}
                                                            />
                                                        </div>
                                                    ) : (
                                                        <div className="relative">
                                                            <img
                                                                src={duplicatePreview}
                                                                alt="To duplicate"
                                                                className="w-full rounded-lg border border-slate-600 cursor-pointer hover:border-amber-500 transition-colors"
                                                                onClick={() => openImageModal(duplicatePreview, 'Duplicate Source')}
                                                            />
                                                            <button
                                                                onClick={clearDuplicate}
                                                                className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full p-1 transition-colors"
                                                            >
                                                                <X className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Count Selector */}
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-300 mb-2">
                                                        Number of Copies
                                                    </label>
                                                    <select
                                                        value={duplicateCount}
                                                        onChange={(e) => setDuplicateCount(Number(e.target.value))}
                                                        className="w-full bg-slate-900 text-white text-sm rounded-lg p-2.5 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                    >
                                                        {[1,2,3,4,5,6,7,8,9,10].map(n => (
                                                            <option key={n} value={n}>{n} Cop{n === 1 ? 'y' : 'ies'}</option>
                                                        ))}
                                                    </select>
                                                </div>

                                                {/* Fill Button */}
                                                <div>
                                                    <button
                                                        onClick={fillDuplicates}
                                                        disabled={!duplicateImage}
                                                        className="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-slate-700 disabled:cursor-not-allowed text-white font-semibold py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2 text-sm"
                                                    >
                                                        <Upload className="w-4 h-4" />
                                                        Fill {duplicateCount} Slot{duplicateCount !== 1 ? 's' : ''}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Image Collection Section - Collapsible */}
                                <div className="mb-4">
                                    <button
                                        onClick={() => setCollectionOpen(!collectionOpen)}
                                        className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                                    >
                                        <div className="flex items-center gap-3">
                                            <Folder className="w-5 h-5 text-blue-500" />
                                            <span className="text-white font-medium">Image Collection</span>
                                            <span className="text-slate-400 text-sm">
                                                {uploadedCollection.length} saved image{uploadedCollection.length !== 1 ? 's' : ''}
                                            </span>
                                        </div>
                                        <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${collectionOpen ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {collectionOpen && (
                                        <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                            <div className="flex items-center justify-between mb-3">
                                                <p className="text-slate-400 text-sm">
                                                    Click an image to preview, use + button to add
                                                </p>
                                                {uploadedCollection.length > 0 && (
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={downloadAllFromCollection}
                                                            className="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                                        >
                                                            <Download className="w-3 h-3" />
                                                            Download All
                                                        </button>
                                                        <button
                                                            onClick={clearCollection}
                                                            className="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                                        >
                                                            <Trash className="w-3 h-3" />
                                                            Clear
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Drop zone for collection */}
                                            <div
                                                className="border-2 border-dashed border-slate-600 hover:border-blue-500 rounded-lg p-4 text-center cursor-pointer transition-all mb-4"
                                                onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                onDrop={(e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                                                    files.forEach(file => {
                                                        const reader = new FileReader();
                                                        reader.onloadend = () => {
                                                            addToCollection(reader.result, file.name);
                                                        };
                                                        reader.readAsDataURL(file);
                                                    });
                                                }}
                                            >
                                                <Folder className="w-6 h-6 text-blue-400 mx-auto mb-2" />
                                                <p className="text-slate-300 text-sm">Drop images here to save to collection</p>
                                            </div>
                                            
                                            {uploadedCollection.length > 0 ? (
                                                <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2">
                                                    {uploadedCollection.map((img) => (
                                                        <div 
                                                            key={img.id} 
                                                            className="relative group cursor-pointer"
                                                            onClick={() => openImageModal(img.preview, img.fileName || 'Collection Image')}
                                                        >
                                                            <img
                                                                src={img.preview}
                                                                alt={img.fileName}
                                                                className="w-full aspect-square object-cover rounded border border-slate-600 hover:border-amber-500 transition-colors"
                                                            />
                                                            {/* X button at top right */}
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); removeFromCollection(img.id); }}
                                                                className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
                                                                title="Remove"
                                                            >
                                                                <X className="w-2.5 h-2.5" />
                                                            </button>
                                                            {/* Plus and Download buttons centered */}
                                                            <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center gap-1">
                                                                <button
                                                                    onClick={(e) => { 
                                                                        e.stopPropagation(); 
                                                                        if (mode === 'edit') useFromCollectionForBatch(img);
                                                                        else if (mode === 'multi') useFromCollectionForMulti(img);
                                                                        else if (mode === 'combine') useFromCollectionForCombine(img);
                                                                    }}
                                                                    className="bg-amber-500 hover:bg-amber-600 text-white p-1 rounded"
                                                                    title="Use in current mode"
                                                                >
                                                                    <Plus className="w-2.5 h-2.5" />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); downloadFromCollection(img); }}
                                                                    className="bg-green-500 hover:bg-green-600 text-white p-1 rounded"
                                                                    title="Download"
                                                                >
                                                                    <Download className="w-2.5 h-2.5" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <p className="text-slate-500 text-sm text-center">No images in collection yet. Uploaded images are automatically saved here.</p>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Stats Bar */}
                                <div className="flex items-center justify-center gap-6 text-sm mb-6">
                                    <div className="flex items-center gap-2">
                                        <Upload className="w-4 h-4 text-blue-400" />
                                        <span className="text-slate-400">
                                            <span className="text-white font-semibold">{getActiveCount()}</span> Ready
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <CheckCircle className="w-4 h-4 text-green-400" />
                                        <span className="text-slate-400">
                                            <span className="text-white font-semibold">{getCompletedCount()}</span> Completed
                                        </span>
                                    </div>
                                </div>

                                {/* Action Buttons */}
                                <div className="flex gap-4 mb-6">
                                    <button
                                        onClick={processAll}
                                        disabled={getActiveCount() === 0 || images.some(img => img.loading)}
                                        className="flex-1 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-700 disabled:cursor-not-allowed text-white font-semibold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg"
                                    >
                                        {images.some(img => img.loading) ? (
                                            <>
                                                <Loader2 className="w-5 h-5 animate-spin" />
                                                Processing...
                                            </>
                                        ) : (
                                            <>
                                                <Zap className="w-5 h-5" />
                                                Process All Images ({getActiveCount()})
                                            </>
                                        )}
                                    </button>
                                    
                                    {getCompletedCount() > 0 && (
                                        <button
                                            onClick={downloadAll}
                                            className="bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-2"
                                        >
                                            <Download className="w-5 h-5" />
                                            Download All ({getCompletedCount()})
                                        </button>
                                    )}
                                </div>

                                {/* Image Slots Grid */}
                                <div className="grid gap-6">
                                    {images.slice(0, visibleSlots).map((img, index) => (
                                        <div key={img.id} className="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-xl">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-xl font-semibold text-white">Image {index + 1}</h3>
                                                <div className="flex items-center gap-2">
                                                    {img.results && img.results.length > 0 && (
                                                        <CheckCircle className="w-6 h-6 text-green-400" />
                                                    )}
                                                    {visibleSlots > 1 && (
                                                        <button
                                                            onClick={() => {
                                                                // Clear the slot and reduce visible count
                                                                removeImage(index);
                                                                setVisibleSlots(prev => prev - 1);
                                                            }}
                                                            className="text-slate-500 hover:text-red-400 p-1 transition-colors"
                                                            title="Remove slot"
                                                        >
                                                            <X className="w-5 h-5" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="grid md:grid-cols-2 gap-6">
                                                {/* Left: Upload & Settings */}
                                                <div className="space-y-4">
                                                    {/* Upload Area */}
                                                    {!img.imagePreview ? (
                                                        <div
                                                            className="border-2 border-dashed border-slate-600 hover:border-slate-500 rounded-lg p-8 text-center cursor-pointer transition-all"
                                                            onClick={() => fileInputRefs.current[index]?.click()}
                                                            onDragEnter={(e) => {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                            }}
                                                            onDragOver={(e) => {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                            }}
                                                            onDrop={(e) => {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                                const file = e.dataTransfer.files[0];
                                                                if (file) handleFileInput(index, file);
                                                            }}
                                                        >
                                                            <Upload className="w-10 h-10 text-slate-400 mx-auto mb-3" />
                                                            <p className="text-slate-300 mb-1">Click or drag image here</p>
                                                            <p className="text-slate-500 text-sm">JPG, PNG, WebP</p>
                                                            <input
                                                                ref={el => fileInputRefs.current[index] = el}
                                                                type="file"
                                                                className="hidden"
                                                                accept="image/*"
                                                                onChange={(e) => e.target.files?.[0] && handleFileInput(index, e.target.files[0])}
                                                            />
                                                        </div>
                                                    ) : (
                                                        <div className="relative">
                                                            <img
                                                                src={img.imagePreview}
                                                                alt={`Preview ${index + 1}`}
                                                                className="w-full rounded-lg border border-slate-600 cursor-pointer hover:border-blue-500 transition-colors"
                                                                onClick={() => openImageModal(img.imagePreview, `Source Image ${index + 1}`)}
                                                            />
                                                            <div className="absolute top-2 right-2 flex gap-1">
                                                                <button
                                                                    onClick={() => {
                                                                        const link = document.createElement('a');
                                                                        link.href = img.imagePreview;
                                                                        link.download = `source-image-${index + 1}-${Date.now()}.jpg`;
                                                                        document.body.appendChild(link);
                                                                        link.click();
                                                                        document.body.removeChild(link);
                                                                    }}
                                                                    className="bg-green-500 hover:bg-green-600 text-white rounded-full p-2 transition-colors"
                                                                    title="Download Source"
                                                                >
                                                                    <Download className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={() => addToCollection(img.imagePreview, `image-${index + 1}.jpg`)}
                                                                    className="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2 transition-colors"
                                                                    title="Save to Collection"
                                                                >
                                                                    <Folder className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={() => removeImage(index)}
                                                                    className="bg-red-500 hover:bg-red-600 text-white rounded-full p-2 transition-colors"
                                                                >
                                                                    <X className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* Prompt */}
                                                    <textarea
                                                        value={img.prompt}
                                                        onChange={(e) => updateImage(index, { prompt: e.target.value })}
                                                        placeholder="Describe your editing instructions..."
                                                        className="w-full h-48 bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/20 resize-none text-sm"
                                                    />

                                                    {/* Settings */}
                                                    <div className="grid grid-cols-3 gap-3">
                                                        <div>
                                                            <label className="block text-xs font-medium text-slate-400 mb-1">
                                                                Aspect Ratio
                                                            </label>
                                                            <select
                                                                value={img.aspectRatio}
                                                                onChange={(e) => updateImage(index, { aspectRatio: e.target.value })}
                                                                className="w-full bg-slate-900 text-white text-sm rounded-lg p-2 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                            >
                                                                <option value="auto">Auto</option>
                                                                <option value="1:1">1:1</option>
                                                                <option value="16:9">16:9</option>
                                                                <option value="9:16">9:16</option>
                                                                <option value="4:3">4:3</option>
                                                                <option value="3:4">3:4</option>
                                                                <option value="21:9">21:9</option>
                                                                <option value="2:3">2:3</option>
                                                                <option value="3:2">3:2</option>
                                                                <option value="4:5">4:5</option>
                                                                <option value="5:4">5:4</option>
                                                            </select>
                                                        </div>

                                                        <div>
                                                            <label className="block text-xs font-medium text-slate-400 mb-1">
                                                                Resolution
                                                            </label>
                                                            <select
                                                                value={img.resolution}
                                                                onChange={(e) => updateImage(index, { resolution: e.target.value })}
                                                                className="w-full bg-slate-900 text-white text-sm rounded-lg p-2 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                            >
                                                                <option value="1K">1K</option>
                                                                <option value="2K">2K</option>
                                                                <option value="4K">4K</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-xs font-medium text-slate-400 mb-1">
                                                                Variations
                                                            </label>
                                                            <select
                                                                value={img.variations}
                                                                onChange={(e) => updateImage(index, { variations: Number(e.target.value) })}
                                                                className="w-full bg-slate-900 text-white text-sm rounded-lg p-2 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                            >
                                                                {[1,2,3,4,5,6,7,8,9,10].map(n => (
                                                                    <option key={n} value={n}>{n}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    </div>

                                                    {/* Individual Process Button */}
                                                    <button
                                                        onClick={() => processImage(index)}
                                                        disabled={img.loading || !img.image || !img.prompt.trim()}
                                                        className="w-full bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 text-sm"
                                                    >
                                                        {img.loading ? (
                                                            <>
                                                                <Loader2 className="w-4 h-4 animate-spin" />
                                                                Processing...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <Camera className="w-4 h-4" />
                                                                Process This Image
                                                            </>
                                                        )}
                                                    </button>
                                                </div>

                                                {/* Right: Result */}
                                                <div>
                                                    {img.error && (
                                                        <div className="bg-red-500/10 border border-red-500 rounded-lg p-3 mb-4">
                                                            <p className="text-red-400 text-sm">{img.error}</p>
                                                        </div>
                                                    )}

                                                    {(!img.results || img.results.length === 0) && !img.loading && (
                                                        <div className="flex items-center justify-center h-full border-2 border-dashed border-slate-600 rounded-lg">
                                                            <div className="text-center">
                                                                <Camera className="w-12 h-12 text-slate-600 mx-auto mb-2" />
                                                                <p className="text-slate-400 text-sm">Result will appear here</p>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {img.loading && (
                                                        <div className="flex items-center justify-center h-full border-2 border-dashed border-slate-600 rounded-lg">
                                                            <div className="text-center">
                                                                <Loader2 className="w-12 h-12 text-amber-500 mx-auto mb-2 animate-spin" />
                                                                <p className="text-slate-300 font-semibold text-sm">
                                                                    Generating {img.variations} variation{img.variations > 1 ? 's' : ''}...
                                                                </p>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {img.results && img.results.length > 0 && (
                                                        <div className="space-y-3">
                                                            {img.results.length === 1 ? (
                                                                <>
                                                                    <img
                                                                        src={img.results[0]}
                                                                        alt={`Result ${index + 1}`}
                                                                        className="w-full rounded-lg border border-slate-600 shadow-lg cursor-pointer hover:border-amber-500 transition-colors"
                                                                        onClick={() => openImageModal(img.results[0], `Result ${index + 1}`)}
                                                                    />
                                                                    <div className="flex gap-2">
                                                                        <button
                                                                            onClick={() => downloadImage(index, 0)}
                                                                            className="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-1.5 text-sm"
                                                                        >
                                                                            <Download className="w-4 h-4" />
                                                                            Download
                                                                        </button>
                                                                        <button
                                                                            onClick={() => addResultToCollection(img.results[0], `edited-${index + 1}.jpg`)}
                                                                            className="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-1.5 text-sm"
                                                                            title="Add to Collection"
                                                                        >
                                                                            <Folder className="w-4 h-4" />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => iterateInEditMode(img.results[0])}
                                                                            className="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-1.5 text-sm"
                                                                            title="Iterate - Send result to new slot for further editing"
                                                                        >
                                                                            <RefreshCw className="w-4 h-4" />
                                                                            Iterate
                                                                        </button>
                                                                    </div>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <div className="flex items-center justify-between mb-2">
                                                                        <span className="text-slate-300 text-sm font-medium">{img.results.length} Variations</span>
                                                                        <div className="flex gap-2">
                                                                            <button
                                                                                onClick={() => iterateInEditMode(img.results[0])}
                                                                                className="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                                                                title="Iterate first variation"
                                                                            >
                                                                                <RefreshCw className="w-3 h-3" />
                                                                                Iterate #1
                                                                            </button>
                                                                            <button
                                                                                onClick={() => downloadAllVariations(index)}
                                                                                className="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                                                            >
                                                                                <Download className="w-3 h-3" />
                                                                                Download All
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="grid grid-cols-2 gap-2">
                                                                        {img.results.map((result, varIdx) => (
                                                                            <div key={varIdx} className="relative group">
                                                                                <img
                                                                                    src={result}
                                                                                    alt={`Result ${index + 1} - Variation ${varIdx + 1}`}
                                                                                    className="w-full rounded-lg border border-slate-600 shadow-lg cursor-pointer hover:border-amber-500 transition-colors"
                                                                                    onClick={() => openImageModal(result, `Result ${index + 1} - Variation ${varIdx + 1}`)}
                                                                                />
                                                                                <div className="absolute top-1 left-1 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full">
                                                                                    #{varIdx + 1}
                                                                                </div>
                                                                                <div className="absolute bottom-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                                    <button
                                                                                        onClick={() => downloadImage(index, varIdx)}
                                                                                        className="bg-green-500 hover:bg-green-600 text-white p-1.5 rounded-lg shadow-lg"
                                                                                        title="Download"
                                                                                    >
                                                                                        <Download className="w-3 h-3" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => addResultToCollection(result, `edited-${index + 1}-v${varIdx + 1}.jpg`)}
                                                                                        className="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded-lg shadow-lg"
                                                                                        title="Add to Collection"
                                                                                    >
                                                                                        <Folder className="w-3 h-3" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => iterateInEditMode(result)}
                                                                                        className="bg-amber-500 hover:bg-amber-600 text-white p-1.5 rounded-lg shadow-lg"
                                                                                        title="Iterate - Send to new slot"
                                                                                    >
                                                                                        <RefreshCw className="w-3 h-3" />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Add Image Slot Button */}
                                {visibleSlots < 20 && (
                                    <button
                                        onClick={() => setVisibleSlots(prev => Math.min(20, prev + 1))}
                                        className="w-full mt-4 py-2 border-2 border-dashed border-slate-600 hover:border-amber-500 rounded-lg text-slate-400 hover:text-amber-500 transition-all flex items-center justify-center gap-2"
                                    >
                                        <Plus className="w-4 h-4" />
                                        <span className="text-sm">Add Image Slot</span>
                                    </button>
                                )}
                            </div>

                        {/* MULTI-IMAGE EDIT MODE */}
                        <div className={mode === 'multi' ? '' : 'hidden'}>
                            <div className="max-w-4xl mx-auto">
                                <p className="text-slate-400 text-lg mb-8 text-center">
                                    Upload multiple images and apply the same edits to all of them
                                </p>
                                
                                {/* Image Collection Dropdown at Top */}
                                <div className="mb-4">
                                    <button
                                        onClick={() => setCollectionOpen(!collectionOpen)}
                                        className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                                    >
                                        <div className="flex items-center gap-3">
                                            <Folder className="w-5 h-5 text-blue-500" />
                                            <span className="text-white font-medium">Image Collection</span>
                                            <span className="text-slate-400 text-sm">
                                                {uploadedCollection.length} saved image{uploadedCollection.length !== 1 ? 's' : ''}
                                            </span>
                                        </div>
                                        <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${collectionOpen ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {collectionOpen && (
                                        <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-3">
                                                    <p className="text-slate-400 text-sm">Click to preview, + to add to:</p>
                                                    <select
                                                        value={multiTargetSection}
                                                        onChange={(e) => setMultiTargetSection(Number(e.target.value))}
                                                        className="bg-slate-700 text-white text-sm rounded px-2 py-1 border border-slate-600 focus:border-blue-500 focus:outline-none"
                                                    >
                                                        {Array.from({ length: visibleMultiSlots }).map((_, i) => (
                                                            <option key={i} value={i}>Section {i + 1}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                {uploadedCollection.length > 0 && (
                                                    <div className="flex gap-2">
                                                        <button onClick={downloadAllFromCollection} className="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs">
                                                            <Download className="w-3 h-3" /> Download All
                                                        </button>
                                                        <button onClick={clearCollection} className="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs">
                                                            <Trash className="w-3 h-3" /> Clear
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            <div
                                                className="border-2 border-dashed border-slate-600 hover:border-blue-500 rounded-lg p-4 text-center transition-all mb-4"
                                                onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                onDrop={(e) => {
                                                    e.preventDefault(); e.stopPropagation();
                                                    Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/')).forEach(file => {
                                                        const reader = new FileReader();
                                                        reader.onloadend = () => addToCollection(reader.result, file.name);
                                                        reader.readAsDataURL(file);
                                                    });
                                                }}
                                            >
                                                <Folder className="w-6 h-6 text-blue-400 mx-auto mb-2" />
                                                <p className="text-slate-300 text-sm">Drop images here to save to collection</p>
                                            </div>
                                            {uploadedCollection.length > 0 && (
                                                <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2">
                                                    {uploadedCollection.map((img) => (
                                                        <div key={img.id} className="relative group cursor-pointer" onClick={() => openImageModal(img.preview, img.fileName || 'Collection Image')}>
                                                            <img src={img.preview} alt={img.fileName} className="w-full aspect-square object-cover rounded border border-slate-600 hover:border-blue-500 transition-colors" />
                                                            {/* X button at top right */}
                                                            <button onClick={(e) => { e.stopPropagation(); removeFromCollection(img.id); }} className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10" title="Remove">
                                                                <X className="w-2.5 h-2.5" />
                                                            </button>
                                                            {/* Plus and Download buttons centered */}
                                                            <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center gap-1">
                                                                <button onClick={(e) => { e.stopPropagation(); addImageToMultiSlot(multiTargetSection, { id: generateUniqueId(), base64: img.preview.split(',')[1], preview: img.preview, fileName: img.fileName }); }} className="bg-amber-500 hover:bg-amber-600 text-white p-1 rounded" title={`Add to Section ${multiTargetSection + 1}`}>
                                                                    <Plus className="w-2.5 h-2.5" />
                                                                </button>
                                                                <button onClick={(e) => { e.stopPropagation(); downloadFromCollection(img); }} className="bg-green-500 hover:bg-green-600 text-white p-1 rounded" title="Download">
                                                                    <Download className="w-2.5 h-2.5" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Multi-Edit Sections */}
                                {multiSlotsArray.slice(0, visibleMultiSlots).map((slot, index) => (
                                    <div key={slot.id} className="bg-slate-800 rounded-xl p-8 border border-slate-700 shadow-xl mb-6">
                                        {/* Section Header */}
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                                Section {index + 1}
                                                {slot.results?.length > 0 && <CheckCircle className="w-5 h-5 text-green-400" />}
                                            </h3>
                                            {visibleMultiSlots > 1 && (
                                                <button
                                                    onClick={() => {
                                                        setMultiSlotsArray(prev => prev.filter((_, i) => i !== index));
                                                        setVisibleMultiSlots(prev => prev - 1);
                                                    }}
                                                    className="text-slate-500 hover:text-red-400 p-1 transition-colors"
                                                    title="Remove section"
                                                >
                                                    <X className="w-5 h-5" />
                                                </button>
                                            )}
                                        </div>

                                        {slot.error && (
                                            <div className="bg-red-500/10 border border-red-500 rounded-lg p-4 mb-6">
                                                <p className="text-red-400">{slot.error}</p>
                                            </div>
                                        )}

                                        {/* Image Upload */}
                                        <div className="mb-6">
                                            {/* When no images uploaded - show drag and drop zone */}
                                            {slot.images.length === 0 && (
                                                <div
                                                    className="border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-all border-slate-600 hover:border-blue-500 bg-slate-900/50"
                                                    onClick={() => multiFileInputRefs.current[index]?.click()}
                                                    onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                    onDrop={(e) => handleMultiSlotDrop(index, e)}
                                                >
                                                    <Upload className="w-16 h-16 text-blue-400 mx-auto mb-4" />
                                                    <p className="text-white text-lg font-semibold mb-2">
                                                        Drop Images Here
                                                    </p>
                                                    <p className="text-slate-400 mb-1">
                                                        or click to browse
                                                    </p>
                                                    <p className="text-slate-500 text-sm">
                                                        Upload multiple images to edit with the same prompt
                                                    </p>
                                                    <input
                                                        ref={el => multiFileInputRefs.current[index] = el}
                                                        type="file"
                                                        multiple
                                                        accept="image/*"
                                                        className="hidden"
                                                        onChange={(e) => handleMultiSlotFileSelect(index, e)}
                                                    />
                                                </div>
                                            )}

                                            {/* When images are uploaded - show grid with add more button */}
                                            {slot.images.length > 0 && (
                                                <div className="space-y-4">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <p className="text-slate-300 text-sm font-medium">
                                                                {slot.images.length} image{slot.images.length !== 1 ? 's' : ''} uploaded
                                                            </p>
                                                            <p className="text-slate-500 text-xs">
                                                                {slot.images.length < 20 ? `Drop more images or click "Add More"` : 'Maximum images reached'}
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {slot.images.length < 20 && (
                                                                <button
                                                                    onClick={() => multiFileInputRefs.current[index]?.click()}
                                                                    className="bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1.5 rounded flex items-center gap-1"
                                                                >
                                                                    <Upload className="w-3 h-3" />
                                                                    Add More
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => clearMultiSlot(index)}
                                                                className="text-red-400 hover:text-red-300 text-sm px-3 py-1.5 rounded border border-red-400/30 hover:border-red-400 flex items-center gap-1"
                                                            >
                                                                <X className="w-3 h-3" />
                                                                Clear All
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div 
                                                        className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 p-4 rounded-lg border-2 transition-all border-slate-700 bg-slate-900/30"
                                                        onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                        onDrop={(e) => slot.images.length < 20 ? handleMultiSlotDrop(index, e) : null}
                                                    >
                                                        {slot.images.map((img, imgIdx) => (
                                                            <div key={img.id} className="relative group">
                                                                <img
                                                                    src={img.preview}
                                                                    alt={`Upload ${imgIdx + 1}`}
                                                                    className="w-full aspect-square object-cover rounded-lg border-2 border-blue-500/50 cursor-pointer"
                                                                    onClick={() => openImageModal(img.preview, img.fileName || `Image ${imgIdx + 1}`)}
                                                                />
                                                                <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button
                                                                        onClick={() => {
                                                                            const link = document.createElement('a');
                                                                            link.href = img.preview;
                                                                            link.download = `multi-source-${imgIdx + 1}.jpg`;
                                                                            link.click();
                                                                        }}
                                                                        className="bg-green-500 hover:bg-green-600 text-white rounded-full p-1"
                                                                        title="Download"
                                                                    >
                                                                        <Download className="w-3 h-3" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => addToCollection(img.preview, img.fileName || `multi-${imgIdx + 1}.jpg`)}
                                                                        className="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-1"
                                                                        title="Save to Collection"
                                                                    >
                                                                        <Folder className="w-3 h-3" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => removeImageFromMultiSlot(index, imgIdx)}
                                                                        className="bg-red-500 hover:bg-red-600 text-white rounded-full p-1"
                                                                    >
                                                                        <X className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                                <div className="absolute bottom-1 left-1 bg-blue-600 text-white text-xs px-2 py-1 rounded font-semibold">
                                                                    #{imgIdx + 1}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {/* Show placeholder slots for remaining images */}
                                                        {slot.images.length < 20 && Array.from({ length: Math.min(20 - slot.images.length, 4) }).map((_, idx) => (
                                                            <div 
                                                                key={`placeholder-${idx}`} 
                                                                className="aspect-square rounded-lg border-2 border-dashed border-slate-600 bg-slate-800/50 flex items-center justify-center cursor-pointer hover:border-blue-500 transition-colors"
                                                                onClick={() => multiFileInputRefs.current[index]?.click()}
                                                            >
                                                                <div className="text-center">
                                                                    <Upload className="w-6 h-6 text-slate-500 mx-auto mb-1" />
                                                                    <p className="text-slate-500 text-xs">Drop or Click</p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <input
                                                        ref={el => multiFileInputRefs.current[index] = el}
                                                        type="file"
                                                        multiple
                                                        accept="image/*"
                                                        className="hidden"
                                                        onChange={(e) => handleMultiSlotFileSelect(index, e)}
                                                    />
                                                </div>
                                            )}
                                        </div>

                                        {/* Shared Prompt */}
                                        <div className="mb-6">
                                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                                Edit Instructions (Applied to All Images)
                                            </label>
                                            <textarea
                                                value={slot.prompt}
                                                onChange={(e) => updateMultiSlot(index, { prompt: e.target.value })}
                                                placeholder="Apply warm golden hour lighting, enhance shadows, increase contrast..."
                                                className="w-full h-48 bg-slate-900 text-white rounded-lg p-4 border border-slate-600 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/20 resize-none"
                                            />
                                        </div>

                                        {/* Shared Settings */}
                                        <div className="grid grid-cols-3 gap-4 mb-6">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                    Aspect Ratio
                                                </label>
                                                <select
                                                    value={slot.aspectRatio}
                                                    onChange={(e) => updateMultiSlot(index, { aspectRatio: e.target.value })}
                                                    className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                >
                                                    <option value="auto">Auto (Original)</option>
                                                    <option value="1:1">1:1 (Square)</option>
                                                    <option value="16:9">16:9 (Widescreen)</option>
                                                    <option value="9:16">9:16 (Vertical)</option>
                                                    <option value="4:3">4:3 (Landscape)</option>
                                                    <option value="3:4">3:4 (Portrait)</option>
                                                    <option value="21:9">21:9 (Ultrawide)</option>
                                                    <option value="2:3">2:3</option>
                                                    <option value="3:2">3:2</option>
                                                    <option value="4:5">4:5</option>
                                                    <option value="5:4">5:4</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                    Resolution
                                                </label>
                                                <select
                                                    value={slot.resolution}
                                                    onChange={(e) => updateMultiSlot(index, { resolution: e.target.value })}
                                                    className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                >
                                                    <option value="1K">1K</option>
                                                    <option value="2K">2K</option>
                                                    <option value="4K">4K (Recommended)</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                    Variations per Image
                                                </label>
                                                <select
                                                    value={slot.variations}
                                                    onChange={(e) => updateMultiSlot(index, { variations: Number(e.target.value) })}
                                                    className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                >
                                                    {[1,2,3,4,5,6,7,8,9,10].map(n => (
                                                        <option key={n} value={n}>{n} Variation{n !== 1 ? 's' : ''}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Process Button */}
                                        {!slot.loading && (
                                            <button
                                                onClick={() => processMultiSlot(index)}
                                                disabled={slot.images.length === 0 || !slot.prompt.trim()}
                                                className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3 shadow-lg text-lg"
                                            >
                                                <Zap className="w-6 h-6" />
                                                Process All {slot.images.length} Image{slot.images.length !== 1 ? 's' : ''}
                                            </button>
                                        )}

                                        {/* Loading State */}
                                        {slot.loading && (
                                            <div className="text-center py-12">
                                                <Loader2 className="w-16 h-16 text-amber-500 mx-auto mb-4 animate-spin" />
                                                <p className="text-slate-300 text-lg font-semibold">Processing {slot.images.length} image{slot.images.length !== 1 ? 's' : ''} ({slot.variations} variation{slot.variations > 1 ? 's' : ''} each)...</p>
                                                <p className="text-slate-500 text-sm mt-2">Generating {slot.images.length * slot.variations} total image{slot.images.length * slot.variations !== 1 ? 's' : ''}</p>
                                            </div>
                                        )}

                                        {/* Results */}
                                        {slot.results?.length > 0 && !slot.loading && (
                                            <div className="mt-8 pt-8 border-t border-slate-700">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="text-xl font-semibold text-white">
                                                        ‚úÖ {slot.results.length} Image{slot.results.length !== 1 ? 's' : ''} Generated
                                                    </h3>
                                                    <button
                                                        onClick={() => {
                                                            slot.results.forEach((result, idx) => {
                                                                setTimeout(() => {
                                                                    const link = document.createElement('a');
                                                                    link.href = result;
                                                                    link.download = `multi-edit-${index + 1}-${idx + 1}-${Date.now()}.jpg`;
                                                                    link.click();
                                                                }, idx * 200);
                                                            });
                                                        }}
                                                        className="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"
                                                    >
                                                        <Download className="w-4 h-4" />
                                                        Download All
                                                    </button>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    {slot.results.map((result, idx) => (
                                                        <div key={idx} className="space-y-3">
                                                            <div className="relative">
                                                                <img
                                                                    src={result}
                                                                    alt={`Result ${idx + 1}`}
                                                                    className="w-full rounded-lg border border-slate-600 shadow-lg cursor-pointer hover:border-purple-500 transition-colors"
                                                                    onClick={() => openImageModal(result, `Multi-Edit Result ${idx + 1}`)}
                                                                />
                                                                <div className="absolute top-2 left-2 bg-black/60 text-white text-sm px-3 py-1 rounded-full">
                                                                    #{idx + 1}
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => {
                                                                        const link = document.createElement('a');
                                                                        link.href = result;
                                                                        link.download = `multi-edit-${index + 1}-${idx + 1}-${Date.now()}.jpg`;
                                                                        link.click();
                                                                    }}
                                                                    className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                                                                >
                                                                    <Download className="w-4 h-4" />
                                                                    Download
                                                                </button>
                                                                <button
                                                                    onClick={() => addResultToCollection(result, `multi-edit-${index + 1}-${idx + 1}.jpg`)}
                                                                    className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg transition-colors flex items-center justify-center"
                                                                    title="Add to Collection"
                                                                >
                                                                    <Folder className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={() => iterateInMultiMode(result)}
                                                                    className="bg-amber-500 hover:bg-amber-600 text-white py-2 px-3 rounded-lg transition-colors flex items-center justify-center"
                                                                    title="Iterate - Create new section with this result"
                                                                >
                                                                    <RefreshCw className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}

                                {/* Add Section Button */}
                                {visibleMultiSlots < 20 && (
                                    <button
                                        onClick={() => {
                                            const newSlot = {
                                                id: generateUniqueId(),
                                                images: [],
                                                prompt: '',
                                                aspectRatio: 'auto',
                                                resolution: '4K',
                                                variations: 1,
                                                loading: false,
                                                results: [],
                                                error: null
                                            };
                                            setMultiSlotsArray(prev => [...prev, newSlot]);
                                            setVisibleMultiSlots(prev => prev + 1);
                                        }}
                                        className="w-full py-3 border-2 border-dashed border-slate-600 hover:border-blue-500 rounded-lg text-slate-400 hover:text-blue-500 transition-all flex items-center justify-center gap-2"
                                    >
                                        <Plus className="w-5 h-5" />
                                        <span>Add Section</span>
                                    </button>
                                )}
                            </div>
                        </div>
                        {/* MULTI-IMAGE GENERATOR (COMBINE) MODE */}
                        <div className={mode === 'combine' ? '' : 'hidden'}>
                            <div className="max-w-4xl mx-auto">
                                <p className="text-slate-400 text-lg mb-8 text-center">
                                    Combine multiple images into one cohesive output - perfect for putting logos on products, merging scenes, or creative compositions
                                </p>
                                
                                {/* Image Collection Dropdown at Top */}
                                <div className="mb-4">
                                    <button
                                        onClick={() => setCollectionOpen(!collectionOpen)}
                                        className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                                    >
                                        <div className="flex items-center gap-3">
                                            <Folder className="w-5 h-5 text-purple-500" />
                                            <span className="text-white font-medium">Image Collection</span>
                                            <span className="text-slate-400 text-sm">
                                                {uploadedCollection.length} saved image{uploadedCollection.length !== 1 ? 's' : ''}
                                            </span>
                                        </div>
                                        <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${collectionOpen ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {collectionOpen && (
                                        <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-3">
                                                    <p className="text-slate-400 text-sm">Click to preview, + to add to:</p>
                                                    <select
                                                        value={combineTargetSection}
                                                        onChange={(e) => setCombineTargetSection(Number(e.target.value))}
                                                        className="bg-slate-700 text-white text-sm rounded px-2 py-1 border border-slate-600 focus:border-purple-500 focus:outline-none"
                                                    >
                                                        {Array.from({ length: visibleCombineSlots }).map((_, i) => (
                                                            <option key={i} value={i}>Section {i + 1}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                {uploadedCollection.length > 0 && (
                                                    <div className="flex gap-2">
                                                        <button onClick={downloadAllFromCollection} className="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs">
                                                            <Download className="w-3 h-3" /> Download All
                                                        </button>
                                                        <button onClick={clearCollection} className="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs">
                                                            <Trash className="w-3 h-3" /> Clear
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            <div
                                                className="border-2 border-dashed border-slate-600 hover:border-purple-500 rounded-lg p-4 text-center transition-all mb-4"
                                                onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                onDrop={(e) => {
                                                    e.preventDefault(); e.stopPropagation();
                                                    Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/')).forEach(file => {
                                                        const reader = new FileReader();
                                                        reader.onloadend = () => addToCollection(reader.result, file.name);
                                                        reader.readAsDataURL(file);
                                                    });
                                                }}
                                            >
                                                <Folder className="w-6 h-6 text-purple-400 mx-auto mb-2" />
                                                <p className="text-slate-300 text-sm">Drop images here to save to collection</p>
                                            </div>
                                            {uploadedCollection.length > 0 && (
                                                <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2">
                                                    {uploadedCollection.map((img) => (
                                                        <div key={img.id} className="relative group cursor-pointer" onClick={() => openImageModal(img.preview, img.fileName || 'Collection Image')}>
                                                            <img src={img.preview} alt={img.fileName} className="w-full aspect-square object-cover rounded border border-slate-600 hover:border-purple-500 transition-colors" />
                                                            {/* X button at top right */}
                                                            <button onClick={(e) => { e.stopPropagation(); removeFromCollection(img.id); }} className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10" title="Remove">
                                                                <X className="w-2.5 h-2.5" />
                                                            </button>
                                                            {/* Plus and Download buttons centered */}
                                                            <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center gap-1">
                                                                <button onClick={(e) => { e.stopPropagation(); addImageToCombineSlot(combineTargetSection, { id: generateUniqueId(), base64: img.preview.split(',')[1], preview: img.preview, fileName: img.fileName }); }} className="bg-amber-500 hover:bg-amber-600 text-white p-1 rounded" title={`Add to Section ${combineTargetSection + 1}`}>
                                                                    <Plus className="w-2.5 h-2.5" />
                                                                </button>
                                                                <button onClick={(e) => { e.stopPropagation(); downloadFromCollection(img); }} className="bg-green-500 hover:bg-green-600 text-white p-1 rounded" title="Download">
                                                                    <Download className="w-2.5 h-2.5" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Combine Sections */}
                                {combineSlotsArray.slice(0, visibleCombineSlots).map((slot, index) => (
                                    <div key={slot.id} className="bg-slate-800 rounded-xl p-8 border border-slate-700 shadow-xl mb-6">
                                        {/* Section Header */}
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                                Section {index + 1}
                                                {slot.results?.length > 0 && <CheckCircle className="w-5 h-5 text-green-400" />}
                                            </h3>
                                            {visibleCombineSlots > 1 && (
                                                <button
                                                    onClick={() => {
                                                        setCombineSlotsArray(prev => prev.filter((_, i) => i !== index));
                                                        setVisibleCombineSlots(prev => prev - 1);
                                                    }}
                                                    className="text-slate-500 hover:text-red-400 p-1 transition-colors"
                                                    title="Remove section"
                                                >
                                                    <X className="w-5 h-5" />
                                                </button>
                                            )}
                                        </div>

                                        {slot.error && (
                                            <div className="bg-red-500/10 border border-red-500 rounded-lg p-4 mb-6">
                                                <p className="text-red-400">{slot.error}</p>
                                            </div>
                                        )}

                                        {/* Image Upload */}
                                        <div className="mb-6">
                                            {/* When no images uploaded - show drag and drop zone */}
                                            {slot.images.length === 0 && (
                                                <div
                                                    className="border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-all border-slate-600 hover:border-purple-500 bg-slate-900/50"
                                                    onClick={() => combineFileInputRefs.current[index]?.click()}
                                                    onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                    onDrop={(e) => handleCombineSlotDrop(index, e)}
                                                >
                                                    <Upload className="w-16 h-16 text-purple-400 mx-auto mb-4" />
                                                    <p className="text-white text-lg font-semibold mb-2">
                                                        Drop Images Here to Combine
                                                    </p>
                                                    <p className="text-slate-400 mb-1">
                                                        or click to browse
                                                    </p>
                                                    <p className="text-slate-500 text-sm">
                                                        Upload multiple images to merge into one
                                                    </p>
                                                    <input
                                                        ref={el => combineFileInputRefs.current[index] = el}
                                                        type="file"
                                                        multiple
                                                        accept="image/*"
                                                        className="hidden"
                                                        onChange={(e) => handleCombineSlotFileSelect(index, e)}
                                                    />
                                                </div>
                                            )}

                                            {/* When images are uploaded - show grid with add more button */}
                                            {slot.images.length > 0 && (
                                                <div className="space-y-4">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <p className="text-slate-300 text-sm font-medium">
                                                                {slot.images.length} image{slot.images.length !== 1 ? 's' : ''} to combine
                                                            </p>
                                                            <p className="text-slate-500 text-xs">
                                                                {slot.images.length < 20 ? `Drop more images or click "Add More"` : 'Maximum images reached'}
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {slot.images.length < 20 && (
                                                                <button
                                                                    onClick={() => combineFileInputRefs.current[index]?.click()}
                                                                    className="bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1.5 rounded flex items-center gap-1"
                                                                >
                                                                    <Upload className="w-3 h-3" />
                                                                    Add More
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => clearCombineSlot(index)}
                                                                className="text-red-400 hover:text-red-300 text-sm px-3 py-1.5 rounded border border-red-400/30 hover:border-red-400 flex items-center gap-1"
                                                            >
                                                                <X className="w-3 h-3" />
                                                                Clear All
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div 
                                                        className="grid grid-cols-2 md:grid-cols-4 gap-3 p-4 rounded-lg border-2 transition-all border-slate-700 bg-slate-900/30"
                                                        onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                        onDrop={(e) => slot.images.length < 20 ? handleCombineSlotDrop(index, e) : null}
                                                    >
                                                        {slot.images.map((img, imgIdx) => (
                                                            <div key={img.id} className="relative group">
                                                                <img
                                                                    src={img.preview}
                                                                    alt={`Input ${imgIdx + 1}`}
                                                                    className="w-full aspect-square object-cover rounded-lg border-2 border-purple-500/50 cursor-pointer"
                                                                    onClick={() => openImageModal(img.preview, img.fileName || `Image ${imgIdx + 1}`)}
                                                                />
                                                                <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button
                                                                        onClick={() => {
                                                                            const link = document.createElement('a');
                                                                            link.href = img.preview;
                                                                            link.download = `combine-source-${imgIdx + 1}.jpg`;
                                                                            link.click();
                                                                        }}
                                                                        className="bg-green-500 hover:bg-green-600 text-white rounded-full p-1"
                                                                        title="Download"
                                                                    >
                                                                        <Download className="w-3 h-3" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => addToCollection(img.preview, img.fileName || `combine-${imgIdx + 1}.jpg`)}
                                                                        className="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-1"
                                                                        title="Save to Collection"
                                                                    >
                                                                        <Folder className="w-3 h-3" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => removeImageFromCombineSlot(index, imgIdx)}
                                                                        className="bg-red-500 hover:bg-red-600 text-white rounded-full p-1"
                                                                    >
                                                                        <X className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                                <div className="absolute bottom-1 left-1 bg-purple-600 text-white text-xs px-2 py-1 rounded font-semibold">
                                                                    #{imgIdx + 1}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {/* Show placeholder slots for remaining images */}
                                                        {slot.images.length < 20 && Array.from({ length: Math.min(20 - slot.images.length, 4) }).map((_, idx) => (
                                                            <div 
                                                                key={`placeholder-${idx}`} 
                                                                className="aspect-square rounded-lg border-2 border-dashed border-slate-600 bg-slate-800/50 flex items-center justify-center cursor-pointer hover:border-purple-500 transition-colors"
                                                                onClick={() => combineFileInputRefs.current[index]?.click()}
                                                            >
                                                                <div className="text-center">
                                                                    <Upload className="w-6 h-6 text-slate-500 mx-auto mb-1" />
                                                                    <p className="text-slate-500 text-xs">Drop or Click</p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <input
                                                        ref={el => combineFileInputRefs.current[index] = el}
                                                        type="file"
                                                        multiple
                                                        accept="image/*"
                                                        className="hidden"
                                                        onChange={(e) => handleCombineSlotFileSelect(index, e)}
                                                    />
                                                </div>
                                            )}
                                        </div>

                                        {/* Combination Prompt */}
                                        <div className="mb-6">
                                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                                How to Combine the Images
                                            </label>
                                            <textarea
                                                value={slot.prompt}
                                                onChange={(e) => updateCombineSlot(index, { prompt: e.target.value })}
                                                placeholder="Combine these images into one scene... Examples:&#10;‚Ä¢ 'Put the logo from image 1 on the product in image 2 in a metallic style'&#10;‚Ä¢ 'Merge all these people into one group photo at a beach sunset'&#10;‚Ä¢ 'Place the furniture from images 1-3 into the room from image 4'"
                                                className="w-full h-56 bg-slate-900 text-white rounded-lg p-4 border border-slate-600 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20 resize-none"
                                            />
                                            <p className="text-slate-500 text-xs mt-2">üí° Be specific about which images to use and how to combine them</p>
                                        </div>

                                        {/* Shared Settings */}
                                        <div className="grid grid-cols-3 gap-4 mb-6">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                    Output Aspect Ratio
                                                </label>
                                                <select
                                                    value={slot.aspectRatio}
                                                    onChange={(e) => updateCombineSlot(index, { aspectRatio: e.target.value })}
                                                    className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-purple-500 focus:outline-none cursor-pointer"
                                                >
                                                    <option value="auto">Auto</option>
                                                    <option value="1:1">1:1 (Square)</option>
                                                    <option value="16:9">16:9 (Widescreen)</option>
                                                    <option value="9:16">9:16 (Vertical)</option>
                                                    <option value="4:3">4:3 (Landscape)</option>
                                                    <option value="3:4">3:4 (Portrait)</option>
                                                    <option value="21:9">21:9 (Ultrawide)</option>
                                                    <option value="2:3">2:3</option>
                                                    <option value="3:2">3:2</option>
                                                    <option value="4:5">4:5</option>
                                                    <option value="5:4">5:4</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                    Output Resolution
                                                </label>
                                                <select
                                                    value={slot.resolution}
                                                    onChange={(e) => updateCombineSlot(index, { resolution: e.target.value })}
                                                    className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-purple-500 focus:outline-none cursor-pointer"
                                                >
                                                    <option value="1K">1K</option>
                                                    <option value="2K">2K</option>
                                                    <option value="4K">4K (Recommended)</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-slate-300 mb-2">
                                                    Combined Variations
                                                </label>
                                                <select
                                                    value={slot.variations}
                                                    onChange={(e) => updateCombineSlot(index, { variations: Number(e.target.value) })}
                                                    className="w-full bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-purple-500 focus:outline-none cursor-pointer"
                                                >
                                                    {[1,2,3,4,5,6,7,8,9,10].map(n => (
                                                        <option key={n} value={n}>{n} Variation{n !== 1 ? 's' : ''}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Combine Button */}
                                        {!slot.loading && (
                                            <button
                                                onClick={() => processCombineSlot(index)}
                                                disabled={slot.images.length < 2 || !slot.prompt.trim()}
                                                className="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3 shadow-lg text-lg"
                                            >
                                                <Zap className="w-6 h-6" />
                                                Combine {slot.images.length} Image{slot.images.length !== 1 ? 's' : ''} into One
                                            </button>
                                        )}

                                        {/* Loading State */}
                                        {slot.loading && (
                                            <div className="text-center py-12">
                                                <Loader2 className="w-16 h-16 text-purple-500 mx-auto mb-4 animate-spin" />
                                                <p className="text-slate-300 text-lg font-semibold">Merging {slot.images.length} images together ({slot.variations} variation{slot.variations > 1 ? 's' : ''})...</p>
                                                <p className="text-slate-500 text-sm mt-2">This may take {Math.ceil(slot.variations * 30)}-{Math.ceil(slot.variations * 60)} seconds</p>
                                            </div>
                                        )}

                                        {/* Results */}
                                        {slot.results?.length > 0 && !slot.loading && (
                                            <div className="mt-8 pt-8 border-t border-slate-700">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="text-xl font-semibold text-white flex items-center gap-2">
                                                        <CheckCircle className="w-6 h-6 text-green-400" />
                                                        {slot.results.length} Combined Image{slot.results.length > 1 ? 's' : ''} Created!
                                                    </h3>
                                                    {slot.results.length > 1 && (
                                                        <button
                                                            onClick={() => {
                                                                slot.results.forEach((result, idx) => {
                                                                    setTimeout(() => {
                                                                        const link = document.createElement('a');
                                                                        link.href = result;
                                                                        link.download = `combined-${index + 1}-${idx + 1}-${Date.now()}.jpg`;
                                                                        link.click();
                                                                    }, idx * 200);
                                                                });
                                                            }}
                                                            className="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"
                                                        >
                                                            <Download className="w-4 h-4" />
                                                            Download All
                                                        </button>
                                                    )}
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    {slot.results.map((result, idx) => (
                                                        <div key={idx} className="space-y-3">
                                                            <img
                                                                src={result}
                                                                alt={`Combined ${idx + 1}`}
                                                                className="w-full rounded-lg border border-slate-600 shadow-lg cursor-pointer hover:border-purple-500 transition-colors"
                                                                onClick={() => openImageModal(result, `Combined Result ${idx + 1}`)}
                                                            />
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => {
                                                                        const link = document.createElement('a');
                                                                        link.href = result;
                                                                        link.download = `combined-${index + 1}-${idx + 1}-${Date.now()}.jpg`;
                                                                        link.click();
                                                                    }}
                                                                    className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                                                                >
                                                                    <Download className="w-4 h-4" />
                                                                    Download
                                                                </button>
                                                                <button
                                                                    onClick={() => addResultToCollection(result, `combined-${index + 1}-${idx + 1}.jpg`)}
                                                                    className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg transition-colors flex items-center justify-center"
                                                                    title="Add to Collection"
                                                                >
                                                                    <Folder className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={() => iterateInCombineMode(result)}
                                                                    className="bg-amber-500 hover:bg-amber-600 text-white py-2 px-3 rounded-lg transition-colors flex items-center justify-center"
                                                                    title="Iterate - Create new section with this result"
                                                                >
                                                                    <RefreshCw className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}

                                {/* Add Section Button */}
                                {visibleCombineSlots < 20 && (
                                    <button
                                        onClick={() => {
                                            const newSlot = {
                                                id: generateUniqueId(),
                                                images: [],
                                                prompt: '',
                                                aspectRatio: '16:9',
                                                resolution: '4K',
                                                variations: 1,
                                                loading: false,
                                                results: [],
                                                error: null
                                            };
                                            setCombineSlotsArray(prev => [...prev, newSlot]);
                                            setVisibleCombineSlots(prev => prev + 1);
                                        }}
                                        className="w-full py-3 border-2 border-dashed border-slate-600 hover:border-purple-500 rounded-lg text-slate-400 hover:text-purple-500 transition-all flex items-center justify-center gap-2"
                                    >
                                        <Plus className="w-5 h-5" />
                                        <span>Add Section</span>
                                    </button>
                                )}
                            </div>
                        </div>
                        {/* GENERATE MODE */}
                        <div className={mode === 'generate' ? '' : 'hidden'}>
                            <div className="max-w-5xl mx-auto">
                                <p className="text-slate-400 text-lg mb-4 text-center">
                                    Create images from text descriptions using AI
                                </p>
                                
                                {/* Action Button */}
                                <div className="flex items-center justify-center mb-6">
                                    <button
                                        onClick={processAllGenSlots}
                                        disabled={getActiveGenCount() === 0 || genSlotsArray.some(s => s.loading)}
                                        className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-semibold py-2 px-6 rounded-lg transition-all flex items-center gap-2"
                                    >
                                        {genSlotsArray.some(s => s.loading) ? (
                                            <>
                                                <Loader2 className="w-4 h-4 animate-spin" />
                                                Processing...
                                            </>
                                        ) : (
                                            <>
                                                <Sparkles className="w-4 h-4" />
                                                Generate All ({getActiveGenCount()})
                                            </>
                                        )}
                                    </button>
                                </div>

                                {/* Generation Slots */}
                                <div className="grid gap-6">
                                    {genSlotsArray.slice(0, visibleGenSlots).map((slot, index) => (
                                        <div key={slot.id} className="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-xl">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-xl font-semibold text-white">Prompt {index + 1}</h3>
                                                <div className="flex items-center gap-2">
                                                    {slot.results?.length > 0 && (
                                                        <CheckCircle className="w-6 h-6 text-green-400" />
                                                    )}
                                                    {visibleGenSlots > 1 && (
                                                        <button
                                                            onClick={() => {
                                                                setGenSlotsArray(prev => prev.filter((_, i) => i !== index));
                                                                setVisibleGenSlots(prev => prev - 1);
                                                            }}
                                                            className="text-slate-500 hover:text-red-400 p-1 transition-colors"
                                                            title="Remove prompt"
                                                        >
                                                            <X className="w-5 h-5" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="grid md:grid-cols-2 gap-6">
                                                {/* Left: Prompt & Settings */}
                                                <div className="space-y-4">
                                                    {slot.error && (
                                                        <div className="bg-red-500/10 border border-red-500 rounded-lg p-3">
                                                            <p className="text-red-400 text-sm">{slot.error}</p>
                                                        </div>
                                                    )}

                                                    <textarea
                                                        value={slot.prompt}
                                                        onChange={(e) => updateGenSlot(index, { prompt: e.target.value })}
                                                        placeholder="Describe your image... e.g., A photorealistic sunset over mountains with dramatic clouds..."
                                                        className="w-full h-48 bg-slate-900 text-white rounded-lg p-3 border border-slate-600 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/20 resize-none text-sm"
                                                    />

                                                    <div className="grid grid-cols-3 gap-3">
                                                        <div>
                                                            <label className="block text-xs font-medium text-slate-400 mb-1">Aspect Ratio</label>
                                                            <select
                                                                value={slot.aspectRatio}
                                                                onChange={(e) => updateGenSlot(index, { aspectRatio: e.target.value })}
                                                                className="w-full bg-slate-900 text-white text-sm rounded-lg p-2 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                            >
                                                                <option value="auto">Auto</option>
                                                                <option value="1:1">1:1</option>
                                                                <option value="16:9">16:9</option>
                                                                <option value="9:16">9:16</option>
                                                                <option value="4:3">4:3</option>
                                                                <option value="3:4">3:4</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs font-medium text-slate-400 mb-1">Resolution</label>
                                                            <select
                                                                value={slot.resolution}
                                                                onChange={(e) => updateGenSlot(index, { resolution: e.target.value })}
                                                                className="w-full bg-slate-900 text-white text-sm rounded-lg p-2 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                            >
                                                                <option value="1K">1K</option>
                                                                <option value="2K">2K</option>
                                                                <option value="4K">4K</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs font-medium text-slate-400 mb-1">Variations</label>
                                                            <select
                                                                value={slot.variations}
                                                                onChange={(e) => updateGenSlot(index, { variations: Number(e.target.value) })}
                                                                className="w-full bg-slate-900 text-white text-sm rounded-lg p-2 border border-slate-600 focus:border-amber-500 focus:outline-none cursor-pointer"
                                                            >
                                                                {[1,2,3,4,5,6,7,8,9,10].map(n => (
                                                                    <option key={n} value={n}>{n}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <button
                                                        onClick={() => processGenSlot(index)}
                                                        disabled={slot.loading || !slot.prompt.trim()}
                                                        className="w-full bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 text-sm"
                                                    >
                                                        {slot.loading ? (
                                                            <>
                                                                <Loader2 className="w-4 h-4 animate-spin" />
                                                                Generating {slot.variations} image{slot.variations > 1 ? 's' : ''}...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <Sparkles className="w-4 h-4" />
                                                                Generate
                                                            </>
                                                        )}
                                                    </button>
                                                </div>

                                                {/* Right: Results */}
                                                <div>
                                                    {(!slot.results || slot.results.length === 0) && !slot.loading && (
                                                        <div className="flex items-center justify-center h-full border-2 border-dashed border-slate-600 rounded-lg">
                                                            <div className="text-center">
                                                                <Sparkles className="w-12 h-12 text-slate-600 mx-auto mb-2" />
                                                                <p className="text-slate-400 text-sm">Results will appear here</p>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {slot.loading && (
                                                        <div className="flex items-center justify-center h-full border-2 border-dashed border-slate-600 rounded-lg">
                                                            <div className="text-center">
                                                                <Loader2 className="w-12 h-12 text-amber-500 mx-auto mb-2 animate-spin" />
                                                                <p className="text-slate-300 font-semibold text-sm">Generating...</p>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {slot.results?.length > 0 && (
                                                        <div className="space-y-3">
                                                            {slot.results.length === 1 ? (
                                                                <>
                                                                    <img 
                                                                        src={slot.results[0]} 
                                                                        alt="Generated" 
                                                                        className="w-full rounded-lg border border-slate-600 shadow-lg cursor-pointer hover:border-blue-500 transition-colors"
                                                                        onClick={() => openImageModal(slot.results[0], `Generated Image ${index + 1}`)}
                                                                    />
                                                                    <div className="flex gap-2">
                                                                        <button
                                                                            onClick={() => downloadGenSlotImage(index, 0)}
                                                                            className="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-1.5 text-sm"
                                                                        >
                                                                            <Download className="w-4 h-4" />
                                                                            Download
                                                                        </button>
                                                                        <button
                                                                            onClick={() => addResultToCollection(slot.results[0], `generated-${index + 1}.jpg`)}
                                                                            className="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center"
                                                                            title="Add to Collection"
                                                                        >
                                                                            <Folder className="w-4 h-4" />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => iterateInEditMode(slot.results[0])}
                                                                            className="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-1.5 text-sm"
                                                                            title="Iterate - Send to Image Editor for further editing"
                                                                        >
                                                                            <RefreshCw className="w-4 h-4" />
                                                                            Iterate
                                                                        </button>
                                                                    </div>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <div className="flex items-center justify-between mb-2">
                                                                        <span className="text-slate-300 text-sm font-medium">{slot.results.length} Variations</span>
                                                                        <div className="flex gap-2">
                                                                            <button
                                                                                onClick={() => iterateInEditMode(slot.results[0])}
                                                                                className="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                                                                title="Iterate first variation in Editor"
                                                                            >
                                                                                <RefreshCw className="w-3 h-3" />
                                                                                Iterate #1
                                                                            </button>
                                                                            <button
                                                                                onClick={() => downloadAllGenSlotImages(index)}
                                                                                className="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                                                            >
                                                                                <Download className="w-3 h-3" />
                                                                                Download All
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="grid grid-cols-2 gap-2">
                                                                        {slot.results.map((result, varIdx) => (
                                                                            <div key={varIdx} className="relative group">
                                                                                <img 
                                                                                    src={result} 
                                                                                    alt={`Variation ${varIdx + 1}`} 
                                                                                    className="w-full rounded-lg border border-slate-600 shadow-lg cursor-pointer hover:border-blue-500 transition-colors"
                                                                                    onClick={() => openImageModal(result, `Generated Image ${index + 1} - Variation ${varIdx + 1}`)}
                                                                                />
                                                                                <div className="absolute top-1 left-1 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full">#{varIdx + 1}</div>
                                                                                <div className="absolute bottom-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                                    <button
                                                                                        onClick={() => downloadGenSlotImage(index, varIdx)}
                                                                                        className="bg-green-500 hover:bg-green-600 text-white p-1.5 rounded-lg shadow-lg"
                                                                                        title="Download"
                                                                                    >
                                                                                        <Download className="w-3 h-3" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => addResultToCollection(result, `generated-${index + 1}-v${varIdx + 1}.jpg`)}
                                                                                        className="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded-lg shadow-lg"
                                                                                        title="Add to Collection"
                                                                                    >
                                                                                        <Folder className="w-3 h-3" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => iterateInEditMode(result)}
                                                                                        className="bg-amber-500 hover:bg-amber-600 text-white p-1.5 rounded-lg shadow-lg"
                                                                                        title="Iterate - Send to Editor"
                                                                                    >
                                                                                        <RefreshCw className="w-3 h-3" />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Add Prompt Bar */}
                                {visibleGenSlots < 20 && (
                                    <button
                                        onClick={() => {
                                            const newCount = visibleGenSlots + 1;
                                            setVisibleGenSlots(newCount);
                                            setGenSlotsArray(prev => {
                                                if (prev.length >= newCount) return prev;
                                                return [...prev, {
                                                    id: generateUniqueId(),
                                                    prompt: '',
                                                    aspectRatio: 'auto',
                                                    resolution: '4K',
                                                    variations: 1,
                                                    loading: false,
                                                    results: [],
                                                    error: null
                                                }];
                                            });
                                        }}
                                        className="w-full mt-4 py-2 border-2 border-dashed border-slate-600 hover:border-amber-500 rounded-lg text-slate-400 hover:text-amber-500 transition-all flex items-center justify-center gap-2"
                                    >
                                        <Plus className="w-4 h-4" />
                                        <span className="text-sm">Add Prompt</span>
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        {/* History Section */}
                        <div className="mt-8">
                            <button
                                onClick={() => setHistoryOpen(!historyOpen)}
                                className="w-full bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-lg px-4 py-3 flex items-center justify-between transition-all"
                            >
                                <div className="flex items-center gap-3">
                                    <Clock className="w-5 h-5 text-purple-500" />
                                    <span className="text-white font-medium">Generation History</span>
                                    <span className="text-slate-400 text-sm">
                                        {history.length} entr{history.length !== 1 ? 'ies' : 'y'}
                                    </span>
                                </div>
                                <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${historyOpen ? 'rotate-180' : ''}`} />
                            </button>
                            
                            {historyOpen && (
                                <div className="mt-2 bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-4">
                                        <p className="text-slate-400 text-sm">
                                            Last {history.length} generation{history.length !== 1 ? 's' : ''} (max 100)
                                        </p>
                                        {history.length > 0 && (
                                            <button
                                                onClick={clearHistory}
                                                className="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1.5 text-xs"
                                            >
                                                <Trash className="w-3 h-3" />
                                                Clear History
                                            </button>
                                        )}
                                    </div>
                                    
                                    {history.length > 0 ? (
                                        <div className="space-y-4 max-h-96 overflow-y-auto">
                                            {history.map((entry) => {
                                                const isExpanded = expandedHistoryIds.has(entry.id);
                                                const isLongPrompt = entry.prompt.length > 100;
                                                return (
                                                <div key={entry.id} className="bg-slate-900 rounded-lg p-3 border border-slate-700">
                                                    <div className="flex items-start justify-between mb-2">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className={`text-xs px-2 py-0.5 rounded-full ${
                                                                    entry.mode === 'edit' ? 'bg-amber-500/20 text-amber-400' :
                                                                    entry.mode === 'generate' ? 'bg-purple-500/20 text-purple-400' :
                                                                    entry.mode === 'multi' ? 'bg-blue-500/20 text-blue-400' :
                                                                    'bg-green-500/20 text-green-400'
                                                                }`}>
                                                                    {entry.mode === 'edit' ? 'Edit' :
                                                                     entry.mode === 'generate' ? 'Generate' :
                                                                     entry.mode === 'multi' ? 'Multi-Edit' : 'Combine'}
                                                                </span>
                                                                <span className="text-slate-500 text-xs">
                                                                    {new Date(entry.timestamp).toLocaleString()}
                                                                </span>
                                                            </div>
                                                            <p className={`text-slate-300 text-sm ${!isExpanded && isLongPrompt ? 'line-clamp-2' : ''}`}>
                                                                {entry.prompt}
                                                            </p>
                                                            {isLongPrompt && (
                                                                <button
                                                                    onClick={() => toggleHistoryExpand(entry.id)}
                                                                    className="text-amber-400 hover:text-amber-300 text-xs mt-1"
                                                                >
                                                                    {isExpanded ? '‚ñ≤ Show less' : '‚ñº Show more'}
                                                                </button>
                                                            )}
                                                        </div>
                                                        <button
                                                            onClick={() => removeFromHistory(entry.id)}
                                                            className="text-slate-500 hover:text-red-400 p-1"
                                                        >
                                                            <X className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                    <div className="flex gap-2 overflow-x-auto pb-2">
                                                        {entry.sourceImage && (
                                                            <div className="flex-shrink-0 group relative">
                                                                <p className="text-slate-500 text-xs mb-1">Source</p>
                                                                <img
                                                                    src={entry.sourceImage}
                                                                    alt="Source"
                                                                    className="h-16 w-16 object-cover rounded border border-slate-600 cursor-pointer hover:border-blue-500 transition-colors"
                                                                    onClick={() => openImageModal(entry.sourceImage, 'Source Image')}
                                                                />
                                                                <button
                                                                    onClick={() => {
                                                                        const link = document.createElement('a');
                                                                        link.href = entry.sourceImage;
                                                                        link.download = `source-${entry.id}.jpg`;
                                                                        document.body.appendChild(link);
                                                                        link.click();
                                                                        document.body.removeChild(link);
                                                                    }}
                                                                    className="absolute bottom-0 right-0 bg-blue-500 hover:bg-blue-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                                >
                                                                    <Download className="w-2.5 h-2.5" />
                                                                </button>
                                                            </div>
                                                        )}
                                                        {entry.results && entry.results.map((result, idx) => (
                                                            <div key={idx} className="flex-shrink-0 group relative">
                                                                <p className="text-slate-500 text-xs mb-1">Result {idx + 1}</p>
                                                                <img
                                                                    src={result}
                                                                    alt={`Result ${idx + 1}`}
                                                                    className="h-16 w-16 object-cover rounded border border-slate-600 cursor-pointer hover:border-green-500 transition-colors"
                                                                    onClick={() => openImageModal(result, `Result ${idx + 1}`)}
                                                                />
                                                                <button
                                                                    onClick={() => {
                                                                        const link = document.createElement('a');
                                                                        link.href = result;
                                                                        link.download = `history-${entry.id}-${idx + 1}.jpg`;
                                                                        document.body.appendChild(link);
                                                                        link.click();
                                                                        document.body.removeChild(link);
                                                                    }}
                                                                    className="absolute bottom-0 right-0 bg-green-500 hover:bg-green-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                                >
                                                                    <Download className="w-2.5 h-2.5" />
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <p className="text-slate-500 text-sm text-center py-4">No history yet. Generated images will appear here.</p>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="mt-8 text-center text-slate-500 text-sm">
                            <p>‚ö° Powered by {availableModels.find(m => m.id === selectedModel)?.name || 'Google Gemini'} & OpenAI Vision</p>
                        </div>
                    </div>
                    
                    {/* Image Preview Modal */}
                    {modalOpen && modalImage && (
                        <div 
                            className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 cursor-pointer"
                            onClick={closeModal}
                        >
                            <div className="relative max-w-7xl max-h-[95vh] w-full h-full flex flex-col">
                                {/* Modal Header */}
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-white text-xl font-semibold">{modalTitle}</h3>
                                    <button
                                        onClick={closeModal}
                                        className="text-white hover:text-red-400 p-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>
                                
                                {/* Modal Image */}
                                <div 
                                    className="flex-1 flex items-center justify-center overflow-auto"
                                >
                                    <img
                                        src={modalImage}
                                        alt={modalTitle}
                                        className="max-w-full max-h-full object-contain rounded-lg shadow-2xl cursor-pointer"
                                    />
                                </div>
                                
                                {/* Modal Footer */}
                                <div className="mt-4 text-center">
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            const link = document.createElement('a');
                                            link.href = modalImage;
                                            link.download = `image-${Date.now()}.jpg`;
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        }}
                                        className="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors flex items-center gap-2 mx-auto"
                                    >
                                        <Download className="w-5 h-5" />
                                        Download Full Size
                                    </button>
                                    <p className="text-slate-400 text-sm mt-2">Click anywhere or press ESC to close</p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* API Key Settings Modal */}
                    <ApiKeySettings
                        isOpen={settingsOpen}
                        onClose={() => setSettingsOpen(false)}
                        apiKey={apiKey}
                        onSave={handleSaveApiKey}
                        selectedModel={selectedModel}
                        onModelChange={handleSaveModel}
                        availableModels={availableModels}
                        openaiKey={openaiKey}
                        onSaveOpenai={handleSaveOpenaiKey}
                        openaiModel={openaiModel}
                        onOpenaiModelChange={handleSaveOpenaiModel}
                        openaiModels={openaiModels}
                    />
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GeminiImageTools />);
    </script>
</body>
</html>
